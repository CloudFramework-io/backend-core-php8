<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudSQL Class - CloudFramework Backend Core PHP8</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="logo">
                <h2>CloudFramework</h2>
                <p>Backend Core PHP8</p>
            </div>
            <nav>
                <a href="../index.html">Home</a>
                <h3>Core Classes</h3>
                <a href="Core7.html">Core7</a>
                <a href="RESTful.html">RESTful</a>
                <a href="Scripts2020.html">Scripts2020</a>
                <h3>Configuration & Security</h3>
                <a href="CoreConfig.html">CoreConfig</a>
                <a href="CoreCache.html">CoreCache</a>
                <a href="CoreSession.html">CoreSession</a>
                <a href="CoreSecurity.html">CoreSecurity</a>
                <h3>Data Storage</h3>
                <a href="DataStore.html">DataStore</a>
                <a href="Buckets.html">Buckets</a>
                <a href="DataBQ.html">DataBQ</a>
                <a href="CloudSQL.html" class="active">CloudSQL</a>
                <a href="DataSQL.html">DataSQL</a>
                <a href="DataMongoDB.html">DataMongoDB</a>
                <h3>Utilities</h3>
                <a href="Email.html">Email</a>
                <a href="DataValidation.html">DataValidation</a>
                <a href="WorkFlows.html">WorkFlows</a>
                <h3>GCP Integration</h3>
                <a href="GoogleSecrets.html">GoogleSecrets</a>
                <a href="PubSub.html">PubSub</a>
            </nav>
        </aside>
        <main class="content">
<h1>CloudSQL Class</h1>

<h2>Overview</h2>

<p>The <code>CloudSQL</code> class provides a comprehensive interface to Google Cloud SQL (MySQL/PostgreSQL), allowing you to execute queries, manage data, and work with relational databases. It supports both direct connections and Cloud SQL proxy connections.</p>

<h2>Requirements</h2>

<ul>
<li>Google Cloud SQL instance (MySQL or PostgreSQL)</li>
<li>Service account with Cloud SQL Client role</li>
<li>Configuration in <code>config.json</code> or direct connection parameters</li>
</ul>

<h2>Basic Usage</h2>

<pre><code class="language-php">// Load CloudSQL class
<p>$sql = $this->core->loadClass('CloudSQL', [ '/cloudsql/project:region:instance',  // host (Cloud SQL socket) 'root',                                // username 'password',                            // password 'database_name',                       // database '3306',                                // port '',                                    // socket 'utf8mb4'                              // charset ]);</p>

<p>// Execute query $users = $sql->command("SELECT * FROM users WHERE age > ? AND status = ?", [25, 'active']);</p>

<p>// Check for errors if($sql->error()) { print_r($sql->getError()); }</p>
</code></pre>

<h2>Constructor</h2>

<pre><code class="language-php">function __construct(Core7 &$core, $h = '', $u = '', $p = '', $db = '', $port = '3306', $socket = '', $charset = '')
</code></pre>

<strong>Parameters:</strong>
<ul>
<li><code>$h</code> (string): Host (IP, domain, or Cloud SQL socket path)</li>
<li><code>$u</code> (string): Username</li>
<li><code>$p</code> (string): Password</li>
<li><code>$db</code> (string): Database name</li>
<li><code>$port</code> (string): Port (default: '3306')</li>
<li><code>$socket</code> (string): Socket path (optional)</li>
<li><code>$charset</code> (string): Character set (optional, e.g., 'utf8mb4')</li>
</ul>

<strong>Example:</strong>
<pre><code class="language-php">// Direct connection
<p>$sql = $this->core->loadClass('CloudSQL', [ '10.0.0.1', 'myuser', 'mypassword', 'mydatabase', '3306' ]);</p>

<p>// Cloud SQL Unix socket (recommended for App Engine) $sql = $this->core->loadClass('CloudSQL', [ '',                                      // empty host 'root', 'password', 'mydb', '3306', '/cloudsql/project:region:instance'     // socket ]);</p>

<p>// Load from config.json // If parameters are empty, it loads from: // - dbServer, dbUser, dbPassword, dbName, dbSocket, dbPort, dbCharset $sql = $this->core->loadClass('CloudSQL');</p>
</code></pre>

<p>---</p>

<h2>Connection Methods</h2>

<h3>connect()</h3>

<pre><code class="language-php">function connect($h = '', $u = '', $p = '', $db = '', $port = "3306", $socket = '', $charset = ''): bool
</code></pre>

<p>Establishes a connection to the database.</p>

<strong>Parameters:</strong> Same as constructor

<strong>Returns:</strong> <code>true</code> on success, <code>false</code> on error

<strong>Example:</strong>
<pre><code class="language-php">$sql = $this->core->loadClass('CloudSQL');

<p>// Connect manually $sql->connect( '127.0.0.1', 'user', 'pass', 'mydb', '3306' );</p>

<p>if($sql->error()) { echo "Connection failed"; }</p>
</code></pre>

<p>---</p>

<h3>close()</h3>

<pre><code class="language-php">function close(): void
</code></pre>

<p>Closes the database connection.</p>

<strong>Example:</strong>
<pre><code class="language-php">$sql->close();
</code></pre>

<p>---</p>

<h2>Query Execution Methods</h2>

<h3>command()</h3>

<pre><code class="language-php">function command($query, $params = []): array|false
</code></pre>

<p>Executes a SQL query with optional parameter binding.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$query</code> (string): SQL query (use <code>?</code> for parameter placeholders)</li>
<li><code>$params</code> (array): Values to bind to placeholders</li>
</ul>

<strong>Returns:</strong> Array of results for SELECT, <code>true</code> for other queries, <code>false</code> on error

<strong>Example:</strong>
<pre><code class="language-php">$sql = $this->core->loadClass('CloudSQL');

<p>// SELECT query $users = $sql->command("SELECT * FROM users WHERE age > ? AND status = ?", [25, 'active']);</p>

<p>// INSERT query $sql->command("INSERT INTO users (name, email, age) VALUES (?, ?, ?)", [ 'John Doe', 'john@example.com', 30 ]);</p>

<p>// UPDATE query $sql->command("UPDATE users SET status = ? WHERE id = ?", ['active', 123]);</p>

<p>// DELETE query $sql->command("DELETE FROM users WHERE id = ?", [123]);</p>

<p>// Multiple parameters $orders = $sql->command(" SELECT * FROM orders WHERE user_id = ? AND created_at >= ? AND status IN (?, ?) ORDER BY created_at DESC ", [123, '2024-01-01', 'completed', 'shipped']);</p>

<p>// Check results if($sql->error()) { print_r($sql->getError()); } else { foreach($users as $user) { echo $user['name'] . "\n"; } }</p>
</code></pre>

<p>---</p>

<h3>query()</h3>

<pre><code class="language-php">function query($query, $params = []): array|false
</code></pre>

<p>Alias for <code>command()</code> method.</p>

<p>---</p>

<h2>Configuration Methods</h2>

<h3>setConf()</h3>

<pre><code class="language-php">function setConf($var, $value): void
</code></pre>

<p>Sets a configuration variable.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$var</code> (string): Configuration key</li>
</ul>
<p>- <code>dbServer</code>: Database host - <code>dbUser</code>: Database username - <code>dbPassword</code>: Database password - <code>dbName</code>: Database name - <code>dbSocket</code>: Socket path - <code>dbPort</code>: Port number - <code>dbCharset</code>: Character set</p>
<ul>
<li><code>$value</code> (string): Configuration value</li>
</ul>

<strong>Example:</strong>
<pre><code class="language-php">$sql = $this->core->loadClass('CloudSQL');

<p>$sql->setConf('dbServer', '127.0.0.1'); $sql->setConf('dbUser', 'myuser'); $sql->setConf('dbPassword', 'mypass'); $sql->setConf('dbName', 'mydb'); $sql->setConf('dbCharset', 'utf8mb4');</p>

<p>$sql->connect();</p>
</code></pre>

<p>---</p>

<h3>getConf()</h3>

<pre><code class="language-php">function getConf($var): string
</code></pre>

<p>Gets a configuration variable.</p>

<strong>Example:</strong>
<pre><code class="language-php">$host = $sql->getConf('dbServer');
<p>$database = $sql->getConf('dbName');</p>
</code></pre>

<p>---</p>

<h3>setDB()</h3>

<pre><code class="language-php">function setDB($db): void
</code></pre>

<p>Changes the active database.</p>

<strong>Example:</strong>
<pre><code class="language-php">$sql->setDB('another_database');
</code></pre>

<p>---</p>

<h2>Helper Methods</h2>

<h3>getInsertId()</h3>

<pre><code class="language-php">function getInsertId(): int
</code></pre>

<p>Returns the last inserted ID from an INSERT query.</p>

<strong>Example:</strong>
<pre><code class="language-php">$sql->command("INSERT INTO users (name, email) VALUES (?, ?)", ['John', 'john@example.com']);

<p>$userId = $sql->getInsertId(); echo "New user ID: {$userId}";</p>
</code></pre>

<p>---</p>

<h3>getAffectedRows()</h3>

<pre><code class="language-php">function getAffectedRows(): int
</code></pre>

<p>Returns the number of rows affected by the last query.</p>

<strong>Example:</strong>
<pre><code class="language-php">$sql->command("UPDATE users SET status = ? WHERE age > ?", ['active', 18]);

<p>$affected = $sql->getAffectedRows(); echo "Updated {$affected} users";</p>
</code></pre>

<p>---</p>

<h3>getQuery()</h3>

<pre><code class="language-php">function getQuery(): string
</code></pre>

<p>Returns the last executed query.</p>

<strong>Example:</strong>
<pre><code class="language-php">$sql->command("SELECT * FROM users");

<p>echo "Last query: " . $sql->getQuery();</p>
</code></pre>

<p>---</p>

<h3>tableExists()</h3>

<pre><code class="language-php">function tableExists($table): bool
</code></pre>

<p>Checks if a table exists in the database.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$table</code> (string): Table name</li>
</ul>

<strong>Returns:</strong> <code>true</code> if table exists, <code>false</code> otherwise

<strong>Example:</strong>
<pre><code class="language-php">if($sql->tableExists('users')) {
<p>echo "Users table exists"; } else { // Create table $sql->command("CREATE TABLE users (...)"); }</p>
</code></pre>

<p>---</p>

<h2>Error Handling Methods</h2>

<h3>error()</h3>

<pre><code class="language-php">function error(): bool
</code></pre>

<p>Checks if there was an error in the last operation.</p>

<strong>Returns:</strong> <code>true</code> if error exists, <code>false</code> otherwise

<strong>Example:</strong>
<pre><code class="language-php">$users = $sql->command("SELECT * FROM users");

<p>if($sql->error()) { echo "Query failed"; }</p>
</code></pre>

<p>---</p>

<h3>getError()</h3>

<pre><code class="language-php">function getError(): array
</code></pre>

<p>Returns error details.</p>

<strong>Returns:</strong> Array of error messages

<strong>Example:</strong>
<pre><code class="language-php">if($sql->error()) {
<p>$errors = $sql->getError(); foreach($errors as $error) { echo "Error: {$error}\n"; } }</p>
</code></pre>

<p>---</p>

<h3>setError()</h3>

<pre><code class="language-php">function setError($err): void
</code></pre>

<p>Sets an error message.</p>

<p>---</p>

<h2>Pagination Methods</h2>

<h3>setLimit()</h3>

<pre><code class="language-php">function setLimit($limit): void
</code></pre>

<p>Sets the LIMIT for queries.</p>

<strong>Example:</strong>
<pre><code class="language-php">$sql->setLimit(10);
</code></pre>

<p>---</p>

<h3>setPage()</h3>

<pre><code class="language-php">function setPage($page): void
</code></pre>

<p>Sets the page number for pagination.</p>

<strong>Example:</strong>
<pre><code class="language-php">$sql->setLimit(20);
<p>$sql->setPage(2); // Skip first 20 records</p>
</code></pre>

<p>---</p>

<h2>Complete Examples</h2>

<h3>CRUD Operations</h3>

<pre><code class="language-php"><?php
<p>class API extends RESTful { private $sql;</p>

<p>function main() { // Initialize SQL connection $this->sql = $this->core->loadClass('CloudSQL', [ '/cloudsql/my-project:us-central1:myinstance', 'root', 'password', 'mydatabase' ]);</p>

<p>if($this->sql->error()) { return $this->setError('Database connection failed', 500); }</p>

<p>// Route to endpoints $endpoint = $this->params[0] ?? 'list'; if(!$this->useFunction('ENDPOINT_' . $endpoint)) { return $this->setErrorFromCodelib('not-found'); } }</p>

<p>// GET /users/list public function ENDPOINT_list() { if(!$this->checkMethod('GET')) return;</p>

<p>// Pagination $page = (int)($this->formParams['page'] ?? 1); $limit = (int)($this->formParams['limit'] ?? 10); $offset = ($page - 1) * $limit;</p>

<p>// Get users $users = $this->sql->command(" SELECT id, name, email, created_at FROM users WHERE active = 1 ORDER BY created_at DESC LIMIT ? OFFSET ? ", [$limit, $offset]);</p>

<p>// Get total count $result = $this->sql->command("SELECT COUNT(*) as total FROM users WHERE active = 1"); $total = $result[0]['total'];</p>

<p>if($this->sql->error()) { return $this->setError('Failed to fetch users', 500); }</p>

<p>$this->addReturnData([ 'users' => $users, 'pagination' => [ 'page' => $page, 'limit' => $limit, 'total' => $total, 'pages' => ceil($total / $limit) ] ]); }</p>

<p>// POST /users/create public function ENDPOINT_create() { if(!$this->checkMethod('POST')) return;</p>

<p>// Validate if(!$this->checkMandatoryFormParams(['name', 'email'])) return;</p>

<p>// Check if email exists $existing = $this->sql->command(" SELECT id FROM users WHERE email = ? ", [$this->formParams['email']]);</p>

<p>if($existing) { return $this->setError('Email already exists', 409); }</p>

<p>// Insert user $this->sql->command(" INSERT INTO users (name, email, created_at) VALUES (?, ?, NOW()) ", [ $this->formParams['name'], $this->formParams['email'] ]);</p>

<p>if($this->sql->error()) { return $this->setError('Failed to create user', 500); }</p>

<p>$userId = $this->sql->getInsertId();</p>

<p>// Get created user $user = $this->sql->command("SELECT * FROM users WHERE id = ?", [$userId]);</p>

<p>$this->setReturnStatus(201); $this->addReturnData($user[0]); }</p>

<p>// PUT /users/update/{id} public function ENDPOINT_update() { if(!$this->checkMethod('PUT')) return;</p>

<p>$userId = $this->checkMandatoryParam(1, 'User ID required'); if(!$userId) return;</p>

<p>// Check if user exists $user = $this->sql->command("SELECT id FROM users WHERE id = ?", [$userId]); if(!$user) { return $this->setError('User not found', 404); }</p>

<p>// Update user $this->sql->command(" UPDATE users SET name = ?, email = ?, updated_at = NOW() WHERE id = ? ", [ $this->formParams['name'] ?? $user[0]['name'], $this->formParams['email'] ?? $user[0]['email'], $userId ]);</p>

<p>if($this->sql->error()) { return $this->setError('Failed to update user', 500); }</p>

<p>// Get updated user $updatedUser = $this->sql->command("SELECT * FROM users WHERE id = ?", [$userId]);</p>

<p>$this->addReturnData($updatedUser[0]); }</p>

<p>// DELETE /users/delete/{id} public function ENDPOINT_delete() { if(!$this->checkMethod('DELETE')) return;</p>

<p>$userId = $this->checkMandatoryParam(1, 'User ID required'); if(!$userId) return;</p>

<p>// Soft delete $this->sql->command(" UPDATE users SET active = 0, deleted_at = NOW() WHERE id = ? ", [$userId]);</p>

<p>// Or hard delete // $this->sql->command("DELETE FROM users WHERE id = ?", [$userId]);</p>

<p>if($this->sql->error()) { return $this->setError('Failed to delete user', 500); }</p>

<p>$this->setReturnStatus(204); } }</p>
</code></pre>

<h3>Transaction Example</h3>

<pre><code class="language-php">// Start transaction
<p>$sql->command("START TRANSACTION");</p>

<p>try { // Create user $sql->command(" INSERT INTO users (name, email) VALUES (?, ?) ", ['John Doe', 'john@example.com']);</p>

<p>$userId = $sql->getInsertId();</p>

<p>// Create user profile $sql->command(" INSERT INTO user_profiles (user_id, bio, avatar) VALUES (?, ?, ?) ", [$userId, 'Software Developer', '/avatars/default.jpg']);</p>

<p>// Commit transaction $sql->command("COMMIT");</p>

<p>echo "User and profile created successfully";</p>

<p>} catch(Exception $e) { // Rollback on error $sql->command("ROLLBACK"); echo "Transaction failed: " . $e->getMessage(); }</p>
</code></pre>

<h3>Advanced Query Example</h3>

<pre><code class="language-php">// Complex JOIN query
<p>$orders = $sql->command(" SELECT o.id, o.order_number, o.total, u.name as customer_name, u.email as customer_email, COUNT(oi.id) as item_count FROM orders o JOIN users u ON o.user_id = u.id LEFT JOIN order_items oi ON o.id = oi.order_id WHERE o.status = ? AND o.created_at >= ? GROUP BY o.id, u.name, u.email HAVING COUNT(oi.id) > ? ORDER BY o.created_at DESC LIMIT ? ", ['completed', '2024-01-01', 0, 100]);</p>
</code></pre>

<h3>Connection Pool Pattern</h3>

<pre><code class="language-php">class API extends RESTful
<p>{ private static $sqlConnection = null;</p>

<p>function main() { // Reuse connection across multiple requests if(self::$sqlConnection === null) { self::$sqlConnection = $this->core->loadClass('CloudSQL', [ $_ENV['DB_HOST'], $_ENV['DB_USER'], $_ENV['DB_PASS'], $_ENV['DB_NAME'] ]);</p>

<p>if(self::$sqlConnection->error()) { return $this->setError('Database connection failed', 500); } }</p>

<p>$this->sql = self::$sqlConnection;</p>

<p>// Route to endpoints $endpoint = $this->params[0] ?? 'list'; $this->useFunction('ENDPOINT_' . $endpoint); } }</p>
</code></pre>

<p>---</p>

<h2>Best Practices</h2>

<h3>1. Use Parameterized Queries</h3>

<p>Always use parameterized queries to prevent SQL injection:</p>

<pre><code class="language-php">// Good
<p>$users = $sql->command("SELECT * FROM users WHERE email = ?", [$email]);</p>

<p>// Bad $users = $sql->command("SELECT * FROM users WHERE email = '{$email}'");</p>
</code></pre>

<h3>2. Handle Errors Properly</h3>

<pre><code class="language-php">$result = $sql->command("SELECT * FROM users");

<p>if($sql->error()) { $this->core->logs->add($sql->getError(), 'database', 'error'); return $this->setError('Database query failed', 500); }</p>
</code></pre>

<h3>3. Close Connections</h3>

<pre><code class="language-php">// Close connection when done (optional, automatically closed on script end)
<p>$sql->close();</p>
</code></pre>

<h3>4. Use Transactions for Multiple Operations</h3>

<pre><code class="language-php">$sql->command("START TRANSACTION");

<p>// Multiple operations $sql->command("INSERT INTO..."); $sql->command("UPDATE...");</p>

<p>if($sql->error()) { $sql->command("ROLLBACK"); } else { $sql->command("COMMIT"); }</p>
</code></pre>

<h3>5. Use Connection Pooling</h3>

<p>Reuse connections across multiple API calls for better performance.</p>

<p>---</p>

<h2>Cloud SQL Specific Notes</h2>

<h3>Cloud SQL Unix Sockets (App Engine)</h3>

<pre><code class="language-php">$sql = $this->core->loadClass('CloudSQL', [
<p>'',                                      // empty host 'root', 'password', 'mydb', '3306', '/cloudsql/project:region:instance'     // Cloud SQL socket ]);</p>
</code></pre>

<h3>Cloud SQL Proxy</h3>

<p>For local development, use Cloud SQL Proxy:</p>

<pre><code class="language-shell"># Start proxy
<p>./cloud_sql_proxy -instances=project:region:instance=tcp:3306</p>

<h1>Connect normally</h1>
<p>$sql = $this->core->loadClass('CloudSQL', [ '127.0.0.1', 'root', 'password', 'mydb', '3306' ]);</p>
</code></pre>

<p>---</p>

<h2>See Also</h2>

<ul>
<li><a href="../guides/getting-started.html">Getting Started Guide</a></li>
<li><a href="../guides/gcp-integration.html">GCP Integration Guide</a></li>
<li><a href="DataStore.html">DataStore Class</a></li>
<li><a href="DataBQ.html">DataBQ Class</a></li>
</ul>

        </main>
    </div>
    <script src="../js/main.js"></script>
</body>
</html>
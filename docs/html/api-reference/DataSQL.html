<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataSQL Class - CloudFramework Backend Core PHP8</title>
    <meta name="description" content="DataSQL Class - CloudFramework Backend Core PHP8 API Reference">
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>CloudFramework Backend Core PHP8</h1>
        <span class="version">v8.4+</span>
    </header>

    <!-- Container -->
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-search">
                <input type="text" id="search-input" placeholder="Search documentation...">
            </div>

            <nav class="sidebar-nav">
                <!-- Getting Started -->
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Getting Started</div>
                    <ul>
                        <li><a href="../index.html" class="sidebar-nav-link">Documentation Home</a></li>
                        <li><a href="../guides/getting-started.html" class="sidebar-nav-link">Installation & Setup</a></li>
                        <li><a href="../guides/getting-started.html#quick-start" class="sidebar-nav-link">Quick Start</a></li>
                    </ul>
                </div>

                <!-- Development Guides -->
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Development Guides</div>
                    <ul>
                        <li><a href="../guides/api-development.html" class="sidebar-nav-link">API Development</a></li>
                        <li><a href="../guides/script-development.html" class="sidebar-nav-link">Script Development</a></li>
                        <li><a href="../guides/configuration.html" class="sidebar-nav-link">Configuration</a></li>
                        <li><a href="../guides/deployment.html" class="sidebar-nav-link">Deployment</a></li>
                    </ul>
                </div>

                <!-- GCP Integration -->
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">GCP Integration</div>
                    <ul>
                        <li><a href="../guides/gcp-integration.html" class="sidebar-nav-link">GCP Overview</a></li>
                        <li><a href="../guides/security.html" class="sidebar-nav-link">Security</a></li>
                        <li><a href="../guides/testing.html" class="sidebar-nav-link">Testing</a></li>
                    </ul>
                </div>

                <!-- Core Classes -->
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Core Classes</div>
                    <ul>
                        <li><a href="Core7.html" class="sidebar-nav-link">Core7</a></li>
                        <li><a href="RESTful.html" class="sidebar-nav-link">RESTful</a></li>
                        <li><a href="Scripts2020.html" class="sidebar-nav-link">Scripts2020</a></li>
                    </ul>
                </div>

                <!-- Configuration Classes -->
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Configuration</div>
                    <ul>
                        <li><a href="CoreConfig.html" class="sidebar-nav-link">CoreConfig</a></li>
                        <li><a href="CoreCache.html" class="sidebar-nav-link">CoreCache</a></li>
                        <li><a href="CoreSession.html" class="sidebar-nav-link">CoreSession</a></li>
                        <li><a href="CoreSecurity.html" class="sidebar-nav-link">CoreSecurity</a></li>
                    </ul>
                </div>

                <!-- Data Access Classes -->
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Data Access</div>
                    <ul>
                        <li><a href="DataStore.html" class="sidebar-nav-link">DataStore</a></li>
                        <li><a href="Buckets.html" class="sidebar-nav-link">Buckets</a></li>
                        <li><a href="DataBQ.html" class="sidebar-nav-link">DataBQ</a></li>
                        <li><a href="CloudSQL.html" class="sidebar-nav-link">CloudSQL</a></li>
                        <li><a href="DataSQL.html" class="sidebar-nav-link active">DataSQL</a></li>
                        <li><a href="DataMongoDB.html" class="sidebar-nav-link">DataMongoDB</a></li>
                    </ul>
                </div>

                <!-- Utilities -->
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Utilities</div>
                    <ul>
                        <li><a href="Email.html" class="sidebar-nav-link">Email</a></li>
                        <li><a href="DataValidation.html" class="sidebar-nav-link">DataValidation</a></li>
                        <li><a href="WorkFlows.html" class="sidebar-nav-link">WorkFlows</a></li>
                        <li><a href="GoogleSecrets.html" class="sidebar-nav-link">GoogleSecrets</a></li>
                        <li><a href="PubSub.html" class="sidebar-nav-link">PubSub</a></li>
                    </ul>
                </div>

                <!-- Examples -->
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Examples</div>
                    <ul>
                        <li><a href="../examples/api-examples.html" class="sidebar-nav-link">API Examples</a></li>
                        <li><a href="../examples/script-examples.html" class="sidebar-nav-link">Script Examples</a></li>
                    </ul>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
<h1>DataSQL Class</h1>

<h2>Overview</h2>

The <code>DataSQL</code> class provides a model-based interface for querying SQL databases (MySQL, PostgreSQL, etc.) in CloudFramework. It offers a fluent API for building SELECT queries with WHERE conditions, JOINs, GROUP BY, ORDER BY, and pagination.

<strong>Note:</strong> This class is primarily for <strong>reading data</strong> (SELECT queries). For write operations, use the CloudSQL class directly or DataStore for NoSQL operations.

<h2>Loading the Class</h2>

<pre><code class="language-php">$model = [
    'model' => [
        'id' => ['int', 'isKey'],
        'name' => ['varchar(255)'],
        'email' => ['varchar(255)', 'index'],
        'status' => ['int', 'index'],
        'created_at' => ['datetime']
    ]
];

$sql = $this->core->loadClass('DataSQL', ['users', $model]);
</code></pre>

<h2>Properties</h2>

<h3>Public Properties</h3>

<table>
<thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>$version</code></td>
<td>string</td>
<td>Class version</td>
</tr>
<tr>
<td><code>$core</code></td>
<td>Core7</td>
<td>Reference to Core7 instance</td>
</tr>
<tr>
<td><code>$error</code></td>
<td>bool</td>
<td>Error flag</td>
</tr>
<tr>
<td><code>$errorMsg</code></td>
<td>string</td>
<td>Error message</td>
</tr>
<tr>
<td><code>$entity_schema</code></td>
<td>array</td>
<td>Table schema definition</td>
</tr>
<tr>
<td><code>$entity_name</code></td>
<td>string</td>
<td>Table name</td>
</tr>
<tr>
<td><code>$keys</code></td>
<td>array</td>
<td>Primary key fields</td>
</tr>
<tr>
<td><code>$fields</code></td>
<td>array</td>
<td>All table fields with types</td>
</tr>
<tr>
<td><code>$mapping</code></td>
<td>array</td>
<td>Field mapping for aliases</td>
</tr>
<tr>
<td><code>$limit</code></td>
<td>int</td>
<td>Query limit</td>
</tr>
<tr>
<td><code>$page</code></td>
<td>int</td>
<td>Current page (for pagination)</td>
</tr>
<tr>
<td><code>$offset</code></td>
<td>int</td>
<td>Query offset</td>
</tr>
<tr>
<td><code>$order</code></td>
<td>string</td>
<td>ORDER BY clause</td>
</tr>
<tr>
<td><code>$debug</code></td>
<td>bool</td>
<td>Debug mode (auto-enabled in development)</td>
</tr>
<tr>
<td><code>$default_time_zone_to_read</code></td>
<td>string</td>
<td>Timezone for reading dates (default: 'UTC')</td>
</tr>
<tr>
<td><code>$default_time_zone_to_write</code></td>
<td>string</td>
<td>Timezone for writing dates (default: 'UTC')</td>
</tr>
</tbody>
</table>

<p>---</p>

<h2>Constructor</h2>

<pre><code class="language-php">function __construct(Core7 &$core, array $params)
</code></pre>

<p>Initializes DataSQL with table schema.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$core</code> (Core7): Reference to Core7</li>
<li><code>$params</code> (array): Array with <code>[table_name, schema]</code></li>
</ul>

<strong>Schema Structure:</strong>
<pre><code class="language-php">[
    'model' => [
        'field_name' => ['type', 'attributes']
    ],
    'mapping' => [  // Optional
        'db_field' => 'api_field'
    ]
]
</code></pre>

<strong>Field Types:</strong>
<ul>
<li><code>int</code>, <code>bigint</code>, <code>tinyint</code>, <code>smallint</code></li>
<li><code>varchar(N)</code>, <code>text</code>, <code>longtext</code></li>
<li><code>float</code>, <code>double</code>, <code>decimal(N,M)</code></li>
<li><code>datetime</code>, <code>timestamp</code>, <code>date</code>, <code>time</code></li>
<li><code>json</code></li>
</ul>

<strong>Field Attributes:</strong>
<ul>
<li><code>isKey</code> - Primary key field</li>
<li><code>index</code> - Indexed field</li>
<li><code>allownull</code> - Allows NULL values</li>
<li><code>readonly</code> - Read-only field</li>
</ul>

<strong>Example:</strong>
<pre><code class="language-php">$model = [
    'model' => [
        'user_id' => ['int', 'isKey'],
        'username' => ['varchar(100)', 'index'],
        'email' => ['varchar(255)', 'index'],
        'password_hash' => ['varchar(255)'],
        'is_active' => ['tinyint', 'index'],
        'metadata' => ['json', 'allownull'],
        'created_at' => ['datetime'],
        'updated_at' => ['timestamp']
    ]
];

$userSQL = $this->core->loadClass('DataSQL', ['users', $model]);
</code></pre>

<p>---</p>

<h2>Read Methods</h2>

<h3>fetchOneByKey()</h3>

<pre><code class="language-php">function fetchOneByKey($key, string $fields = ''): array
</code></pre>

<p>Fetches a single record by primary key.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$key</code> (string\|int): Primary key value</li>
<li><code>$fields</code> (string): Comma-separated fields to return (optional)</li>
</ul>

<strong>Returns:</strong> Record array, or empty array if not found

<strong>Example:</strong>
<pre><code class="language-php">// Fetch user by ID
$user = $sql->fetchOneByKey(123);
// Returns: ['id' => 123, 'name' => 'John', 'email' => 'john@example.com', ...]

// Fetch specific fields only
$user = $sql->fetchOneByKey(123, 'id,name,email');
// Returns: ['id' => 123, 'name' => 'John', 'email' => 'john@example.com']
</code></pre>

<p>---</p>

<h3>fetchByKeys()</h3>

<pre><code class="language-php">function fetchByKeys($keysWhere, $fields = ''): array
</code></pre>

<p>Fetches multiple records by primary keys.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$keysWhere</code> (array): Array of primary key values</li>
<li><code>$fields</code> (string): Comma-separated fields to return (optional)</li>
</ul>

<strong>Returns:</strong> Array of records

<strong>Example:</strong>
<pre><code class="language-php">// Fetch multiple users by IDs
$users = $sql->fetchByKeys([123, 456, 789]);
// Returns: [
//   ['id' => 123, 'name' => 'John', ...],
//   ['id' => 456, 'name' => 'Jane', ...],
//   ['id' => 789, 'name' => 'Bob', ...]
// ]

// Fetch specific fields
$users = $sql->fetchByKeys([123, 456], 'id,name');
</code></pre>

<p>---</p>

<h3>fetch()</h3>

<pre><code class="language-php">function fetch($keysWhere = [], $fields = null, $params = []): array
</code></pre>

<p>Fetches records with WHERE conditions.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$keysWhere</code> (array): WHERE conditions <code>['field' => 'value']</code></li>
<li><code>$fields</code> (string\|array\|null): Fields to return</li>
<li><code>$params</code> (array): Additional parameters for prepared statements</li>
</ul>

<strong>Returns:</strong> Array of records

<strong>WHERE Condition Formats:</strong>
<pre><code class="language-php">// Simple equals
['status' => 1]

// Special values
['deleted_at' => '__null__']        // IS NULL
['deleted_at' => '__notnull__']     // IS NOT NULL
['name' => '__empty__']             // = ''
['name' => '__notempty__']          // != ''

// Multiple conditions (AND)
['status' => 1, 'is_active' => 1]

// Array for IN clause
['status' => [1, 2, 3]]  // status IN (1, 2, 3)
</code></pre>

<strong>Example:</strong>
<pre><code class="language-php">// Fetch all active users
$users = $sql->fetch(['status' => 1]);

// Fetch with multiple conditions
$users = $sql->fetch([
    'status' => 1,
    'is_verified' => 1
]);

// Fetch specific fields
$users = $sql->fetch(['status' => 1], 'id,name,email');

// Fetch with IN condition
$users = $sql->fetch(['role' => ['admin', 'editor']]);

// Fetch where field is NULL
$deletedUsers = $sql->fetch(['deleted_at' => '__notnull__']);

// Fetch where field is NOT NULL
$activeUsers = $sql->fetch(['deleted_at' => '__null__']);
</code></pre>

<p>---</p>

<h3>fetchOne()</h3>

<pre><code class="language-php">function fetchOne($keysWhere = [], $fields = null, $params = []): array
</code></pre>

<p>Fetches a single record with WHERE conditions.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$keysWhere</code> (array): WHERE conditions</li>
<li><code>$fields</code> (string\|array\|null): Fields to return</li>
<li><code>$params</code> (array): Additional parameters</li>
</ul>

<strong>Returns:</strong> Single record array, or empty array if not found

<strong>Example:</strong>
<pre><code class="language-php">// Fetch user by email
$user = $sql->fetchOne(['email' => 'john@example.com']);

// Fetch with multiple conditions
$user = $sql->fetchOne([
    'email' => 'john@example.com',
    'status' => 1
]);

// Fetch specific fields
$user = $sql->fetchOne(['email' => 'john@example.com'], 'id,name');
</code></pre>

<p>---</p>

<h3>count()</h3>

<pre><code class="language-php">function count(string $fields_count = '*', array|string $keysWhere = [], $params = []): int
</code></pre>

<p>Counts records matching WHERE conditions.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$fields_count</code> (string): Field to count (default: '*')</li>
<li><code>$keysWhere</code> (array): WHERE conditions</li>
<li><code>$params</code> (array): Additional parameters</li>
</ul>

<strong>Returns:</strong> Count as integer

<strong>Example:</strong>
<pre><code class="language-php">// Count all users
$totalUsers = $sql->count();

// Count active users
$activeUsers = $sql->count('*', ['status' => 1]);

// Count distinct emails
$uniqueEmails = $sql->count('DISTINCT email');

// Count with complex condition
$verifiedUsers = $sql->count('*', [
    'status' => 1,
    'is_verified' => 1
]);
</code></pre>

<p>---</p>

<h3>sum()</h3>

<pre><code class="language-php">function sum(string $field, array|string $keysWhere = [], $params = []): float
</code></pre>

<p>Calculates sum of a field.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$field</code> (string): Field to sum</li>
<li><code>$keysWhere</code> (array): WHERE conditions</li>
<li><code>$params</code> (array): Additional parameters</li>
</ul>

<strong>Returns:</strong> Sum as float

<strong>Example:</strong>
<pre><code class="language-php">// Sum all order totals
$total = $sql->sum('total');

// Sum for specific status
$completedTotal = $sql->sum('total', ['status' => 'completed']);
</code></pre>

<p>---</p>

<h3>avg()</h3>

<pre><code class="language-php">function avg(string $field = '', array|string $keysWhere = [], $params = []): float
</code></pre>

<p>Calculates average of a field.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$field</code> (string): Field to average</li>
<li><code>$keysWhere</code> (array): WHERE conditions</li>
<li><code>$params</code> (array): Additional parameters</li>
</ul>

<strong>Returns:</strong> Average as float

<strong>Example:</strong>
<pre><code class="language-php">// Average order amount
$avgAmount = $sql->avg('amount');

// Average rating for product
$avgRating = $sql->avg('rating', ['product_id' => 123]);
</code></pre>

<p>---</p>

<h2>Query Builder Methods</h2>

<h3>setLimit()</h3>

<pre><code class="language-php">function setLimit($limit): void
</code></pre>

<p>Sets the LIMIT clause.</p>

<strong>Example:</strong>
<pre><code class="language-php">$sql->setLimit(10);
$users = $sql->fetch(['status' => 1]);
// Returns up to 10 records
</code></pre>

<p>---</p>

<h3>setPage()</h3>

<pre><code class="language-php">function setPage($page): void
</code></pre>

<p>Sets the page for pagination (auto-calculates OFFSET).</p>

<strong>Example:</strong>
<pre><code class="language-php">$sql->setLimit(25);  // 25 per page
$sql->setPage(2);    // Page 2 (records 26-50)
$users = $sql->fetch();
</code></pre>

<p>---</p>

<h3>setOffset()</h3>

<pre><code class="language-php">function setOffset($offset): void
</code></pre>

<p>Sets the OFFSET clause directly.</p>

<strong>Example:</strong>
<pre><code class="language-php">$sql->setLimit(10);
$sql->setOffset(20);  // Skip first 20 records
$users = $sql->fetch();
</code></pre>

<p>---</p>

<h3>setOrder()</h3>

<pre><code class="language-php">function setOrder($field, $type = 'ASC'): void
</code></pre>

<p>Sets ORDER BY clause (replaces existing order).</p>

<strong>Parameters:</strong>
<ul>
<li><code>$field</code> (string): Field to order by</li>
<li><code>$type</code> (string): 'ASC' or 'DESC'</li>
</ul>

<strong>Example:</strong>
<pre><code class="language-php">// Order by name ascending
$sql->setOrder('name', 'ASC');
$users = $sql->fetch();

// Order by created_at descending
$sql->setOrder('created_at', 'DESC');
$users = $sql->fetch();
</code></pre>

<p>---</p>

<h3>addOrder()</h3>

<pre><code class="language-php">function addOrder($field, $type = 'ASC'): void
</code></pre>

<p>Adds to ORDER BY clause (keeps existing order).</p>

<strong>Example:</strong>
<pre><code class="language-php">// Order by status, then by name
$sql->setOrder('status', 'ASC');
$sql->addOrder('name', 'ASC');
$users = $sql->fetch();
// ORDER BY status ASC, name ASC
</code></pre>

<p>---</p>

<h3>unsetOrder()</h3>

<pre><code class="language-php">function unsetOrder(): void
</code></pre>

<p>Clears ORDER BY clause.</p>

<p>---</p>

<h3>setQueryFields()</h3>

<pre><code class="language-php">function setQueryFields($fields): void
</code></pre>

<p>Defines specific fields to SELECT.</p>

<strong>Example:</strong>
<pre><code class="language-php">$sql->setQueryFields('id,name,email');
$users = $sql->fetch(['status' => 1]);
// Returns only id, name, email
</code></pre>

<p>---</p>

<h3>setQueryWhere()</h3>

<pre><code class="language-php">function setQueryWhere($keysWhere): void
</code></pre>

<p>Sets WHERE conditions for the query.</p>

<strong>Example:</strong>
<pre><code class="language-php">$sql->setQueryWhere(['status' => 1, 'role' => 'admin']);
$users = $sql->fetch();
</code></pre>

<p>---</p>

<h3>addQueryWhere()</h3>

<pre><code class="language-php">function addQueryWhere($keysWhere): void
</code></pre>

<p>Adds to WHERE conditions.</p>

<strong>Example:</strong>
<pre><code class="language-php">$sql->setQueryWhere(['status' => 1]);
$sql->addQueryWhere(['is_verified' => 1]);
$users = $sql->fetch();
// WHERE status = 1 AND is_verified = 1
</code></pre>

<p>---</p>

<h3>setExtraWhere()</h3>

<pre><code class="language-php">function setExtraWhere($extraWhere): void
</code></pre>

<p>Adds raw WHERE clause (advanced).</p>

<strong>Example:</strong>
<pre><code class="language-php">$sql->setExtraWhere("DATE(created_at) >= '2024-01-01'");
$users = $sql->fetch();
</code></pre>

<p>---</p>

<h3>setGroupBy()</h3>

<pre><code class="language-php">function setGroupBy($group): void
</code></pre>

<p>Sets GROUP BY clause.</p>

<strong>Example:</strong>
<pre><code class="language-php">$sql->setQueryFields('status, COUNT(*) as count');
$sql->setGroupBy('status');
$stats = $sql->fetch();
// Returns: [
//   ['status' => 1, 'count' => 50],
//   ['status' => 0, 'count' => 10]
// ]
</code></pre>

<p>---</p>

<h3>join()</h3>

<pre><code class="language-php">function join($type, DataSQL &$object, $first_field, $join_field, $extraon = null): void
</code></pre>

<p>Adds a JOIN clause.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$type</code> (string): 'LEFT', 'RIGHT', 'INNER'</li>
<li><code>$object</code> (DataSQL): DataSQL object to join</li>
<li><code>$first_field</code> (string): Field from first table</li>
<li><code>$join_field</code> (string): Field from joined table</li>
<li><code>$extraon</code> (string\|null): Additional ON conditions</li>
</ul>

<strong>Example:</strong>
<pre><code class="language-php">// Join users with orders
$userSQL = $this->core->loadClass('DataSQL', ['users', $userModel]);
$orderSQL = $this->core->loadClass('DataSQL', ['orders', $orderModel]);

$userSQL->join('LEFT', $orderSQL, 'user_id', 'user_id');
$userSQL->setQueryFields('users.*, orders.total');
$results = $userSQL->fetch();
</code></pre>

<p>---</p>

<h3>reset()</h3>

<pre><code class="language-php">public function reset(): void
</code></pre>

<p>Resets all query builder settings.</p>

<strong>Example:</strong>
<pre><code class="language-php">$sql->reset();  // Clear all limits, orders, wheres, etc.
</code></pre>

<p>---</p>

<h2>Utility Methods</h2>

<h3>getFields()</h3>

<pre><code class="language-php">function getFields(): array
</code></pre>

<p>Returns all field names defined in schema.</p>

<strong>Returns:</strong> Array of field names

<strong>Example:</strong>
<pre><code class="language-php">$fields = $sql->getFields();
// Returns: ['id', 'name', 'email', 'status', 'created_at']
</code></pre>

<p>---</p>

<h2>Common Usage Patterns</h2>

<h3>Pagination</h3>

<pre><code class="language-php">class API extends RESTful
{
    public function ENDPOINT_users()
    {
        $page = (int)($this->formParams['page'] ?? 1);
        $perPage = 25;

        $sql = $this->core->loadClass('DataSQL', ['users', $model]);
        $sql->setLimit($perPage);
        $sql->setPage($page);
        $sql->setOrder('created_at', 'DESC');

        $users = $sql->fetch(['status' => 1]);
        $total = $sql->count('*', ['status' => 1]);

        $this->addReturnData([
            'users' => $users,
            'pagination' => [
                'page' => $page,
                'per_page' => $perPage,
                'total' => $total,
                'total_pages' => ceil($total / $perPage)
            ]
        ]);
    }
}
</code></pre>

<h3>Search and Filter</h3>

<pre><code class="language-php">public function ENDPOINT_search()
{
    $search = $this->formParams['search'] ?? '';
    $status = $this->formParams['status'] ?? null;

    $sql = $this->core->loadClass('DataSQL', ['users', $model]);

    // Build WHERE
    $where = [];
    if($status !== null) {
        $where['status'] = (int)$status;
    }

    // Add search condition
    if($search) {
        $sql->setExtraWhere("(name LIKE '%{$search}%' OR email LIKE '%{$search}%')");
    }

    $sql->setOrder('name', 'ASC');
    $users = $sql->fetch($where);

    $this->addReturnData($users);
}
</code></pre>

<h3>Aggregations</h3>

<pre><code class="language-php">public function ENDPOINT_stats()
{
    $sql = $this->core->loadClass('DataSQL', ['orders', $model]);

    // Total orders
    $totalOrders = $sql->count();

    // Total revenue
    $totalRevenue = $sql->sum('total', ['status' => 'completed']);

    // Average order value
    $avgOrderValue = $sql->avg('total', ['status' => 'completed']);

    // Orders by status
    $sql->reset();
    $sql->setQueryFields('status, COUNT(*) as count, SUM(total) as total');
    $sql->setGroupBy('status');
    $byStatus = $sql->fetch();

    $this->addReturnData([
        'total_orders' => $totalOrders,
        'total_revenue' => $totalRevenue,
        'avg_order_value' => $avgOrderValue,
        'by_status' => $byStatus
    ]);
}
</code></pre>

<h3>Complex Queries with JOINs</h3>

<pre><code class="language-php">public function ENDPOINT_user_orders()
{
    $userId = $this->params[0] ?? null;
    if(!$userId) {
        return $this->setErrorFromCodelib('params-error', 'User ID required');
    }

    // Create SQL objects
    $userSQL = $this->core->loadClass('DataSQL', ['users', $userModel]);
    $orderSQL = $this->core->loadClass('DataSQL', ['orders', $orderModel]);

    // Join users with orders
    $userSQL->join('LEFT', $orderSQL, 'id', 'user_id');
    $userSQL->setQueryFields('users.*, orders.id as order_id, orders.total, orders.created_at as order_date');
    $userSQL->setQueryWhere(['users.id' => $userId]);
    $userSQL->setOrder('orders.created_at', 'DESC');

    $results = $userSQL->fetch();

    $this->addReturnData($results);
}
</code></pre>

<h3>Date Range Queries</h3>

<pre><code class="language-php">public function ENDPOINT_recent()
{
    $days = (int)($this->formParams['days'] ?? 7);
    $date = date('Y-m-d H:i:s', strtotime("-{$days} days"));

    $sql = $this->core->loadClass('DataSQL', ['users', $model]);
    $sql->setExtraWhere("created_at >= '{$date}'");
    $sql->setOrder('created_at', 'DESC');

    $recentUsers = $sql->fetch();

    $this->addReturnData([
        'days' => $days,
        'count' => count($recentUsers),
        'users' => $recentUsers
    ]);
}
</code></pre>

<p>---</p>

<h2>Performance Tips</h2>

<h3>1. Select Only Needed Fields</h3>

<pre><code class="language-php">// Bad: Fetches all fields
$users = $sql->fetch();

// Good: Fetch only what you need
$users = $sql->fetch([], 'id,name,email');
</code></pre>

<h3>2. Use Indexes</h3>

<pre><code class="language-php">// Define indexes in schema
$model = [
    'model' => [
        'id' => ['int', 'isKey'],
        'email' => ['varchar(255)', 'index'],  // Indexed
        'status' => ['int', 'index'],         // Indexed
    ]
];
</code></pre>

<h3>3. Use Limits</h3>

<pre><code class="language-php">// Always use limits for lists
$sql->setLimit(100);
$users = $sql->fetch();
</code></pre>

<h3>4. Reset Between Queries</h3>

<pre><code class="language-php">// Reset to avoid carrying over settings
$sql->reset();
$sql->setLimit(10);
$users = $sql->fetch();
</code></pre>

<p>---</p>

<h2>Debug Mode</h2>

Debug mode logs all SQL queries:

<pre><code class="language-php">$sql->debug = true;

$users = $sql->fetch(['status' => 1]);
// Logs: SELECT * FROM users WHERE status = 1
</code></pre>

<p>Auto-enabled in development environment.</p>

<p>---</p>

<h2>Error Handling</h2>

<pre><code class="language-php">$sql = $this->core->loadClass('DataSQL', ['users', $model]);
$users = $sql->fetch(['status' => 1]);

if($sql->error) {
    $this->core->logs->add('SQL Error: ' . $sql->errorMsg);
    return $this->setErrorFromCodelib('database-error', 'Failed to fetch users');
}
</code></pre>

<p>---</p>

<h2>See Also</h2>

<ul>
<li><a href="CloudSQL.html">CloudSQL Class Reference</a> - For write operations (INSERT, UPDATE, DELETE)</li>
<li><a href="DataStore.html">DataStore Class Reference</a> - NoSQL alternative with write operations</li>
<li><a href="../guides/api-development.html">API Development Guide</a></li>
<li><a href="../examples/api-examples.md#database">Database Examples</a></li>
</ul>

        </main>
    </div>

    <script src="../js/main.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoreSession Class - CloudFramework Backend Core PHP8</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="logo">
                <h2>CloudFramework</h2>
                <p>Backend Core PHP8</p>
            </div>
            <nav>
                <a href="../index.html">Home</a>
                <h3>Core Classes</h3>
                <a href="Core7.html">Core7</a>
                <a href="RESTful.html">RESTful</a>
                <a href="Scripts2020.html">Scripts2020</a>
                <h3>Configuration & Security</h3>
                <a href="CoreConfig.html">CoreConfig</a>
                <a href="CoreCache.html">CoreCache</a>
                <a href="CoreSession.html" class="active">CoreSession</a>
                <a href="CoreSecurity.html">CoreSecurity</a>
                <h3>Data Storage</h3>
                <a href="DataStore.html">DataStore</a>
                <a href="Buckets.html">Buckets</a>
                <a href="DataBQ.html">DataBQ</a>
                <a href="CloudSQL.html">CloudSQL</a>
                <a href="DataSQL.html">DataSQL</a>
                <a href="DataMongoDB.html">DataMongoDB</a>
                <h3>Utilities</h3>
                <a href="Email.html">Email</a>
                <a href="DataValidation.html">DataValidation</a>
                <a href="WorkFlows.html">WorkFlows</a>
                <h3>GCP Integration</h3>
                <a href="GoogleSecrets.html">GoogleSecrets</a>
                <a href="PubSub.html">PubSub</a>
            </nav>
        </aside>
        <main class="content">
<h1>CoreSession Class</h1>

<h2>Overview</h2>

<p>The <code>CoreSession</code> class provides a simple and efficient session management system in CloudFramework. It wraps PHP's native session handling with automatic compression and serialization of session data.</p>

<h2>Inheritance</h2>

<p>Access CoreSession through the Core7 instance:</p>

<pre><code class="language-php">// Set session variable
<p>$this->core->session->set('user_id', 123);</p>

<p>// Get session variable $userId = $this->core->session->get('user_id');</p>

<p>// Delete session variable $this->core->session->delete('user_id');</p>
</code></pre>

<h2>Properties</h2>

<h3>Public Properties</h3>

<p>| Property | Type | Description | |----------|------|-------------| | <code>$start</code> | bool | Whether session has been started | | <code>$id</code> | string | Current session ID | | <code>$debug</code> | bool | Debug mode flag (auto-enabled in development) | | <code>$core</code> | Core7 | Reference to Core7 instance |</p>

<p>---</p>

<h2>Constructor</h2>

<pre><code class="language-php">function __construct(Core7 &$core, $debug = null)
</code></pre>

<p>Initializes the session manager.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$core</code> (Core7): Reference to Core7 instance</li>
<li><code>$debug</code> (bool\|null): Enable debug mode (optional, auto-enabled in development)</li>
</ul>

<strong>Auto-initialization:</strong>
<ul>
<li>Detects if session is already active</li>
<li>Automatically enables debug mode in development environment</li>
<li>Stores session ID if session is active</li>
</ul>

<p>---</p>

<h2>Session Methods</h2>

<h3>init()</h3>

<pre><code class="language-php">function init($id = ''): void
</code></pre>

<p>Initializes or resumes a session.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$id</code> (string): Optional session ID to use (useful for session restoration)</li>
</ul>

<strong>Behavior:</strong>
<ul>
<li>Starts a new session if none exists</li>
<li>Resumes existing session if already active</li>
<li>Can switch to a different session ID if provided</li>
<li>Automatically called by <code>get()</code>, <code>set()</code>, and <code>delete()</code> if session not started</li>
</ul>

<strong>Example:</strong>
<pre><code class="language-php">// Start session with default ID
<p>$this->core->session->init();</p>

<p>// Start session with specific ID (useful for session restoration) $sessionId = $_COOKIE['custom_session_id'] ?? ''; if($sessionId) { $this->core->session->init($sessionId); }</p>

<p>// Get session ID $currentSessionId = $this->core->session->id;</p>
</code></pre>

<p>---</p>

<h3>get()</h3>

<pre><code class="language-php">function get($var): mixed
</code></pre>

<p>Retrieves a variable from the session.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$var</code> (string): Variable name</li>
</ul>

<strong>Returns:</strong> Variable value, or <code>null</code> if not found

<strong>Example:</strong>
<pre><code class="language-php">// Get simple value
<p>$userId = $this->core->session->get('user_id');</p>

<p>// Get complex object $userData = $this->core->session->get('user_data'); // Returns: ['name' => 'John', 'email' => 'john@example.com']</p>

<p>// Check if variable exists $cart = $this->core->session->get('shopping_cart'); if($cart === null) { // Variable doesn't exist $cart = []; }</p>

<p>// Get with default $language = $this->core->session->get('language') ?? 'en';</p>
</code></pre>

<strong>Data Handling:</strong>
<ul>
<li>Automatically initializes session if not started</li>
<li>Uncompresses and unserializes stored data</li>
<li>Returns <code>null</code> if variable doesn't exist</li>
<li>Handles exceptions gracefully</li>
</ul>

<p>---</p>

<h3>set()</h3>

<pre><code class="language-php">function set($var, $value): void
</code></pre>

<p>Stores a variable in the session.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$var</code> (string): Variable name</li>
<li><code>$value</code> (mixed): Variable value (any serializable type)</li>
</ul>

<strong>Example:</strong>
<pre><code class="language-php">// Set simple value
<p>$this->core->session->set('user_id', 123);</p>

<p>// Set complex object $this->core->session->set('user_data', [ 'id' => 123, 'name' => 'John Doe', 'email' => 'john@example.com', 'roles' => ['user', 'admin'] ]);</p>

<p>// Set array $this->core->session->set('shopping_cart', [ ['product_id' => 1, 'quantity' => 2], ['product_id' => 5, 'quantity' => 1] ]);</p>

<p>// Update existing value $cart = $this->core->session->get('shopping_cart') ?? []; $cart[] = ['product_id' => 10, 'quantity' => 1]; $this->core->session->set('shopping_cart', $cart);</p>
</code></pre>

<strong>Data Handling:</strong>
<ul>
<li>Automatically initializes session if not started</li>
<li>Serializes and compresses data before storing</li>
<li>Supports any serializable PHP type (arrays, objects, etc.)</li>
</ul>

<p>---</p>

<h3>delete()</h3>

<pre><code class="language-php">function delete($var): void
</code></pre>

<p>Removes a variable from the session.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$var</code> (string): Variable name to delete</li>
</ul>

<strong>Example:</strong>
<pre><code class="language-php">// Delete single variable
<p>$this->core->session->delete('user_id');</p>

<p>// Clear user session on logout $this->core->session->delete('user_id'); $this->core->session->delete('user_data'); $this->core->session->delete('shopping_cart');</p>

<p>// Or use a loop $sessionVars = ['user_id', 'user_data', 'shopping_cart', 'preferences']; foreach($sessionVars as $var) { $this->core->session->delete($var); }</p>
</code></pre>

<p>---</p>

<h2>Common Usage Patterns</h2>

<h3>User Authentication</h3>

<pre><code class="language-php">class API extends RESTful
<p>{ public function ENDPOINT_login() { $email = $this->formParams['email'] ?? ''; $password = $this->formParams['password'] ?? '';</p>

<p>// Validate credentials $user = $this->validateCredentials($email, $password); if($user) { // Store user in session $this->core->session->set('user_id', $user['id']); $this->core->session->set('user_data', $user); $this->core->session->set('authenticated', true);</p>

<p>$this->addReturnData([ 'message' => 'Login successful', 'user' => $user ]); } else { $this->setErrorFromCodelib('auth-error', 'Invalid credentials'); } }</p>

<p>public function ENDPOINT_logout() { // Clear session variables $this->core->session->delete('user_id'); $this->core->session->delete('user_data'); $this->core->session->delete('authenticated');</p>

<p>$this->addReturnData('Logout successful'); }</p>

<p>protected function checkAuthentication(): bool { return $this->core->session->get('authenticated') === true; } }</p>
</code></pre>

<h3>Shopping Cart</h3>

<pre><code class="language-php">class API extends RESTful
<p>{ public function ENDPOINT_cart_add() { $productId = $this->formParams['product_id'] ?? ''; $quantity = (int)($this->formParams['quantity'] ?? 1);</p>

<p>if(!$productId) { return $this->setErrorFromCodelib('params-error', 'Product ID required'); }</p>

<p>// Get current cart $cart = $this->core->session->get('shopping_cart') ?? [];</p>

<p>// Add or update product $found = false; foreach($cart as &$item) { if($item['product_id'] == $productId) { $item['quantity'] += $quantity; $found = true; break; } }</p>

<p>if(!$found) { $cart[] = [ 'product_id' => $productId, 'quantity' => $quantity, 'added_at' => time() ]; }</p>

<p>// Save cart $this->core->session->set('shopping_cart', $cart);</p>

<p>$this->addReturnData([ 'cart' => $cart, 'total_items' => count($cart) ]); }</p>

<p>public function ENDPOINT_cart_get() { $cart = $this->core->session->get('shopping_cart') ?? [];</p>

<p>$this->addReturnData([ 'cart' => $cart, 'total_items' => count($cart) ]); }</p>

<p>public function ENDPOINT_cart_clear() { $this->core->session->delete('shopping_cart'); $this->addReturnData('Cart cleared'); } }</p>
</code></pre>

<h3>Multi-step Forms (Wizard)</h3>

<pre><code class="language-php">class API extends RESTful
<p>{ public function ENDPOINT_wizard_step1() { if(!$this->checkMethod('POST')) return;</p>

<p>$data = [ 'company_name' => $this->formParams['company_name'] ?? '', 'industry' => $this->formParams['industry'] ?? '' ];</p>

<p>// Validate if(!$data['company_name']) { return $this->setErrorFromCodelib('validation-error', 'Company name required'); }</p>

<p>// Store in session $wizardData = $this->core->session->get('wizard_data') ?? []; $wizardData['step1'] = $data; $wizardData['current_step'] = 2; $this->core->session->set('wizard_data', $wizardData);</p>

<p>$this->addReturnData([ 'message' => 'Step 1 completed', 'next_step' => 2 ]); }</p>

<p>public function ENDPOINT_wizard_step2() { if(!$this->checkMethod('POST')) return;</p>

<p>// Get previous data $wizardData = $this->core->session->get('wizard_data') ?? []; if(empty($wizardData['step1'])) { return $this->setErrorFromCodelib('state-error', 'Please complete step 1 first'); }</p>

<p>// Store step 2 data $wizardData['step2'] = [ 'contact_name' => $this->formParams['contact_name'] ?? '', 'email' => $this->formParams['email'] ?? '' ]; $wizardData['current_step'] = 3; $this->core->session->set('wizard_data', $wizardData);</p>

<p>$this->addReturnData([ 'message' => 'Step 2 completed', 'next_step' => 3 ]); }</p>

<p>public function ENDPOINT_wizard_complete() { if(!$this->checkMethod('POST')) return;</p>

<p>// Get all wizard data $wizardData = $this->core->session->get('wizard_data') ?? [];</p>

<p>if(empty($wizardData['step1']) || empty($wizardData['step2'])) { return $this->setErrorFromCodelib('state-error', 'Please complete all steps'); }</p>

<p>// Process complete registration $result = $this->processRegistration($wizardData);</p>

<p>// Clear wizard data $this->core->session->delete('wizard_data');</p>

<p>$this->addReturnData([ 'message' => 'Registration completed', 'result' => $result ]); } }</p>
</code></pre>

<h3>User Preferences</h3>

<pre><code class="language-php">class API extends RESTful
<p>{ function main() { // Load user preferences from session $preferences = $this->core->session->get('user_preferences') ?? [ 'language' => 'en', 'theme' => 'light', 'timezone' => 'UTC', 'items_per_page' => 25 ];</p>

<p>// Apply preferences $this->core->config->setLang($preferences['language']); date_default_timezone_set($preferences['timezone']);</p>

<p>// Route to endpoint if(!$this->useFunction('ENDPOINT_' . ($this->params[0] ?? 'default'))) { return $this->setErrorFromCodelib('params-error', 'Endpoint not found'); } }</p>

<p>public function ENDPOINT_preferences_set() { if(!$this->checkMethod('POST')) return;</p>

<p>// Get current preferences $preferences = $this->core->session->get('user_preferences') ?? [];</p>

<p>// Update preferences if(isset($this->formParams['language'])) { $preferences['language'] = $this->formParams['language']; } if(isset($this->formParams['theme'])) { $preferences['theme'] = $this->formParams['theme']; } if(isset($this->formParams['timezone'])) { $preferences['timezone'] = $this->formParams['timezone']; } if(isset($this->formParams['items_per_page'])) { $preferences['items_per_page'] = (int)$this->formParams['items_per_page']; }</p>

<p>// Save preferences $this->core->session->set('user_preferences', $preferences);</p>

<p>$this->addReturnData([ 'message' => 'Preferences updated', 'preferences' => $preferences ]); } }</p>
</code></pre>

<h3>Flash Messages</h3>

<pre><code class="language-php">class API extends RESTful
<p>{ protected function setFlashMessage($type, $message) { $this->core->session->set('flash_message', [ 'type' => $type, 'message' => $message ]); }</p>

<p>protected function getFlashMessage() { $flash = $this->core->session->get('flash_message'); if($flash) { $this->core->session->delete('flash_message'); } return $flash; }</p>

<p>public function ENDPOINT_save_data() { if(!$this->checkMethod('POST')) return;</p>

<p>// Process data $success = $this->saveData($this->formParams);</p>

<p>if($success) { $this->setFlashMessage('success', 'Data saved successfully'); } else { $this->setFlashMessage('error', 'Failed to save data'); }</p>

<p>$this->addReturnData(['redirect' => '/dashboard']); }</p>

<p>public function ENDPOINT_dashboard() { $flash = $this->getFlashMessage();</p>

<p>$this->addReturnData([ 'dashboard_data' => $this->getDashboardData(), 'flash_message' => $flash ]); } }</p>
</code></pre>

<h3>Session Recovery</h3>

<pre><code class="language-php">// In a custom session handler or API endpoint
<p>class API extends RESTful { public function ENDPOINT_session_restore() { $sessionId = $this->formParams['session_id'] ?? '';</p>

<p>if(!$sessionId) { return $this->setErrorFromCodelib('params-error', 'Session ID required'); }</p>

<p>// Validate session ID format/security if(!$this->isValidSessionId($sessionId)) { return $this->setErrorFromCodelib('security-error', 'Invalid session ID'); }</p>

<p>// Restore session $this->core->session->init($sessionId);</p>

<p>// Check if session has user data $userId = $this->core->session->get('user_id'); if($userId) { $userData = $this->core->session->get('user_data'); $this->addReturnData([ 'message' => 'Session restored', 'user' => $userData ]); } else { $this->setErrorFromCodelib('auth-error', 'No active session found'); } } }</p>
</code></pre>

<p>---</p>

<h2>Session Security</h2>

<h3>Session ID Management</h3>

<pre><code class="language-php">// Get current session ID (for cookies, etc.)
<p>$sessionId = $this->core->session->id;</p>

<p>// Store in secure cookie setcookie('app_session', $sessionId, [ 'expires' => time() + 3600, 'path' => '/', 'secure' => true, 'httponly' => true, 'samesite' => 'Strict' ]);</p>
</code></pre>

<h3>Session Regeneration (Anti-Fixation)</h3>

<pre><code class="language-php">// After successful login, regenerate session ID
<p>public function ENDPOINT_login() { $user = $this->validateCredentials($email, $password);</p>

<p>if($user) { // Regenerate session ID to prevent session fixation session_regenerate_id(true);</p>

<p>// Update stored session ID $this->core->session->id = session_id();</p>

<p>// Store user data $this->core->session->set('user_id', $user['id']); $this->core->session->set('authenticated', true); } }</p>
</code></pre>

<h3>Session Timeout</h3>

<pre><code class="language-php">// Track last activity
<p>public function checkSessionTimeout() { $lastActivity = $this->core->session->get('last_activity'); $timeout = 1800; // 30 minutes</p>

<p>if($lastActivity && (time() - $lastActivity) > $timeout) { // Session expired $this->core->session->delete('user_id'); $this->core->session->delete('authenticated'); $this->core->session->delete('last_activity');</p>

<p>return false; }</p>

<p>// Update last activity $this->core->session->set('last_activity', time());</p>

<p>return true; }</p>
</code></pre>

<p>---</p>

<h2>Debug Mode</h2>

<p>When debug mode is enabled, session operations are logged:</p>

<pre><code class="language-php">// Enable debug
<p>$this->core->session->debug = true;</p>

<p>// Operations will be logged $this->core->session->set('test', 'value'); // Log: "set('$var=test') ok"</p>

<p>$value = $this->core->session->get('test'); // Log: "get('$var=test') found"</p>

<p>$this->core->session->delete('test'); // Log: "delete('$var=test') ok"</p>
</code></pre>

<p>Debug mode is automatically enabled in development environment.</p>

<p>---</p>

<h2>Performance Considerations</h2>

<h3>Data Compression</h3>

<p>Session data is automatically compressed using gzip:</p>

<pre><code class="language-php">// Data is compressed before storing
<p>$this->core->session->set('large_data', $bigArray); // Stored as: gzcompress(serialize($bigArray))</p>

<p>// And decompressed when retrieved $data = $this->core->session->get('large_data'); // Returns: original $bigArray</p>
</code></pre>

<p>This reduces session storage size significantly.</p>

<h3>Avoid Storing Large Objects</h3>

<pre><code class="language-php">// Bad: Storing huge datasets in session
<p>$allProducts = $this->getAllProducts(); // 10,000 products $this->core->session->set('products', $allProducts);</p>

<p>// Good: Store only IDs or use cache $productIds = $this->getProductIds(); $this->core->session->set('product_ids', $productIds);</p>

<p>// Or use cache for large datasets $this->core->cache->set('products', $allProducts, 3600);</p>
</code></pre>

<p>---</p>

<h2>Important Notes</h2>

<h3>Session Variable Naming</h3>

<p>Session variables are prefixed with <code>CloudSessionVar_</code> internally:</p>

<pre><code class="language-php">// You use
<p>$this->core->session->set('user_id', 123);</p>

<p>// Actually stored as $_SESSION['CloudSessionVar_user_id']</p>

<p>// This prevents conflicts with other session variables</p>
</code></pre>

<h3>Serialization</h3>

<p>All session data is automatically serialized and unserialized:</p>

<pre><code class="language-php">// You can store any serializable type
<p>$this->core->session->set('user', $userObject); $this->core->session->set('array', ['a', 'b', 'c']); $this->core->session->set('number', 123); $this->core->session->set('bool', true);</p>

<p>// Retrieved with original type $user = $this->core->session->get('user'); // object $array = $this->core->session->get('array'); // array $number = $this->core->session->get('number'); // int $bool = $this->core->session->get('bool'); // bool</p>
</code></pre>

<p>---</p>

<h2>See Also</h2>

<ul>
<li><a href="Core7.html">Core7 Class Reference</a></li>
<li><a href="CoreSecurity.html">CoreSecurity Class Reference</a></li>
<li><a href="../guides/security.html">Security Guide</a></li>
<li><a href="../guides/api-development.html">API Development Guide</a></li>
</ul>

        </main>
    </div>
    <script src="../js/main.js"></script>
</body>
</html>
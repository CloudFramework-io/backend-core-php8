<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PubSub Class - CloudFramework Backend Core PHP8</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="logo">
                <h2>CloudFramework</h2>
                <p>Backend Core PHP8</p>
            </div>
            <nav>
                <a href="../index.html">Home</a>
                <h3>Core Classes</h3>
                <a href="Core7.html">Core7</a>
                <a href="RESTful.html">RESTful</a>
                <a href="Scripts2020.html">Scripts2020</a>
                <h3>Configuration & Security</h3>
                <a href="CoreConfig.html">CoreConfig</a>
                <a href="CoreCache.html">CoreCache</a>
                <a href="CoreSession.html">CoreSession</a>
                <a href="CoreSecurity.html">CoreSecurity</a>
                <h3>Data Storage</h3>
                <a href="DataStore.html">DataStore</a>
                <a href="Buckets.html">Buckets</a>
                <a href="DataBQ.html">DataBQ</a>
                <a href="CloudSQL.html">CloudSQL</a>
                <a href="DataSQL.html">DataSQL</a>
                <a href="DataMongoDB.html">DataMongoDB</a>
                <h3>Utilities</h3>
                <a href="Email.html">Email</a>
                <a href="DataValidation.html">DataValidation</a>
                <a href="WorkFlows.html">WorkFlows</a>
                <h3>GCP Integration</h3>
                <a href="GoogleSecrets.html">GoogleSecrets</a>
                <a href="PubSub.html" class="active">PubSub</a>
            </nav>
        </aside>
        <main class="content">
<h1>PubSub Class</h1>

<h2>Overview</h2>

<p>The <code>PubSub</code> class provides integration with Google Cloud Pub/Sub for asynchronous messaging between services. It allows publishing and subscribing to messages, enabling event-driven architectures and microservice communication.</p>

<h2>Loading the Class</h2>

<pre><code class="language-php">$pubsub = $this->core->loadClass('PubSub');
</code></pre>

<h2>Methods</h2>

<h3>getTopics()</h3>

<pre><code class="language-php">public function getTopics(): array
</code></pre>

<p>Lists all Pub/Sub topics in the project.</p>

<strong>Returns:</strong> Array of topic names

<strong>Example:</strong>
<pre><code class="language-php">$pubsub = $this->core->loadClass('PubSub');
<p>$topics = $pubsub->getTopics(); // Returns: ['projects/my-project/topics/user-events', ...]</p>
</code></pre>

<p>---</p>

<h3>getSubscriptions()</h3>

<pre><code class="language-php">public function getSubscriptions(): array
</code></pre>

<p>Lists all Pub/Sub subscriptions in the project.</p>

<strong>Returns:</strong> Array of subscription names

<p>---</p>

<h3>getSubscription()</h3>

<pre><code class="language-php">public function getSubscription($subscription, $topic = null): array
</code></pre>

<p>Gets information about a specific subscription.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$subscription</code> (string): Subscription name</li>
<li><code>$topic</code> (string|null): Optional topic name</li>
</ul>

<strong>Returns:</strong> Subscription details array

<p>---</p>

<h3>subscribeTo()</h3>

<pre><code class="language-php">public function subscribeTo($subscriptionName, $topicName): bool
</code></pre>

<p>Creates a subscription to a topic.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$subscriptionName</code> (string): Name for the subscription</li>
<li><code>$topicName</code> (string): Topic to subscribe to</li>
</ul>

<strong>Returns:</strong> <code>true</code> on success

<strong>Example:</strong>
<pre><code class="language-php">$pubsub = $this->core->loadClass('PubSub');
<p>$success = $pubsub->subscribeTo('my-subscription', 'user-events'); if($success) { // Subscription created }</p>
</code></pre>

<p>---</p>

<h3>unsubscribeTo()</h3>

<pre><code class="language-php">public function unsubscribeTo($subscriptionName, $topicName): bool
</code></pre>

<p>Deletes a subscription.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$subscriptionName</code> (string): Subscription to delete</li>
<li><code>$topicName</code> (string): Topic name</li>
</ul>

<strong>Returns:</strong> <code>true</code> on success

<p>---</p>

<h3>pushMessage()</h3>

<pre><code class="language-php">public function pushMessage($message, $attributes = [], $topicName = null): bool
</code></pre>

<p>Publishes a message to a topic.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$message</code> (string): Message content</li>
<li><code>$attributes</code> (array): Optional message attributes (metadata)</li>
<li><code>$topicName</code> (string|null): Topic name</li>
</ul>

<strong>Returns:</strong> <code>true</code> on success

<strong>Example:</strong>
<pre><code class="language-php">$pubsub = $this->core->loadClass('PubSub');

<p>// Simple message $pubsub->pushMessage('User registered', [], 'user-events');</p>

<p>// Message with attributes $pubsub->pushMessage( json_encode(['user_id' => 123, 'email' => 'user@example.com']), ['event' => 'registration', 'source' => 'api'], 'user-events' );</p>
</code></pre>

<p>---</p>

<h3>pullMessages()</h3>

<pre><code class="language-php">public function pullMessages($subscriptionName, $topicName = null, $acknowledge = false): array
</code></pre>

<p>Pulls messages from a subscription.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$subscriptionName</code> (string): Subscription to pull from</li>
<li><code>$topicName</code> (string|null): Optional topic name</li>
<li><code>$acknowledge</code> (bool): Auto-acknowledge messages (default: false)</li>
</ul>

<strong>Returns:</strong> Array of messages

<strong>Example:</strong>
<pre><code class="language-php">$pubsub = $this->core->loadClass('PubSub');

<p>// Pull messages $messages = $pubsub->pullMessages('my-subscription');</p>

<p>foreach($messages as $message) { $data = $message['message']['data']; $attributes = $message['message']['attributes'];</p>

<p>// Process message processEvent($data); }</p>

<p>// Acknowledge if not auto-acknowledged if(!$acknowledge) { $pubsub->acknowledgeLastMessages(); }</p>
</code></pre>

<p>---</p>

<h3>acknowledgeLastMessages()</h3>

<pre><code class="language-php">public function acknowledgeLastMessages($id = null): bool
</code></pre>

<p>Acknowledges received messages to prevent redelivery.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$id</code> (string|null): Optional specific message ID</li>
</ul>

<strong>Returns:</strong> <code>true</code> on success

<p>---</p>

<h2>Common Usage Patterns</h2>

<h3>Publishing Events</h3>

<pre><code class="language-php">class API extends RESTful
<p>{ public function ENDPOINT_register() { // Create user $userId = $this->createUser($this->formParams);</p>

<p>// Publish event $pubsub = $this->core->loadClass('PubSub'); $pubsub->pushMessage( json_encode([ 'user_id' => $userId, 'email' => $this->formParams['email'], 'timestamp' => time() ]), ['event_type' => 'user_registered'], 'user-events' );</p>

<p>$this->addReturnData(['user_id' => $userId]); } }</p>
</code></pre>

<h3>Processing Messages (Script)</h3>

<pre><code class="language-php">class Script extends Scripts2020
<p>{ function main() { $pubsub = $this->core->loadClass('PubSub');</p>

<p>while(true) { // Pull messages $messages = $pubsub->pullMessages('user-events-subscription');</p>

<p>foreach($messages as $msg) { $data = json_decode($msg['message']['data'], true);</p>

<p>// Process event $this->sendWelcomeEmail($data['user_id'], $data['email']);</p>

<p>// Acknowledge $pubsub->acknowledgeLastMessages($msg['ackId']); }</p>

<p>// Wait before next pull sleep(5); } } }</p>
</code></pre>

<h3>Event-Driven Architecture</h3>

<pre><code class="language-php">// Order Service: Publish order created event
<p>$pubsub->pushMessage( json_encode(['order_id' => $orderId, 'user_id' => $userId, 'total' => $total]), ['event' => 'order_created'], 'orders' );</p>

<p>// Inventory Service: Subscribe to order events $messages = $pubsub->pullMessages('inventory-subscription'); foreach($messages as $msg) { $order = json_decode($msg['message']['data'], true); $this->updateInventory($order); }</p>

<p>// Email Service: Subscribe to order events $messages = $pubsub->pullMessages('email-subscription'); foreach($messages as $msg) { $order = json_decode($msg['message']['data'], true); $this->sendOrderConfirmation($order); }</p>
</code></pre>

<p>---</p>

<h2>See Also</h2>

<ul>
<li><a href="../guides/gcp-integration.html">GCP Integration Guide</a></li>
<li><a href="Core7.html">Core7 Class Reference</a></li>
</ul>

        </main>
    </div>
    <script src="../js/main.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buckets Class - CloudFramework Backend Core PHP8</title>
    <meta name="description" content="Buckets Class - CloudFramework Backend Core PHP8 API Reference">
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>CloudFramework Backend Core PHP8</h1>
        <span class="version">v8.4+</span>
    </header>

    <!-- Container -->
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-search">
                <input type="text" id="search-input" placeholder="Search documentation...">
            </div>

            <nav class="sidebar-nav">
                <!-- Getting Started -->
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Getting Started</div>
                    <ul>
                        <li><a href="../index.html" class="sidebar-nav-link">Documentation Home</a></li>
                        <li><a href="../guides/getting-started.html" class="sidebar-nav-link">Installation & Setup</a></li>
                        <li><a href="../guides/getting-started.html#quick-start" class="sidebar-nav-link">Quick Start</a></li>
                    </ul>
                </div>

                <!-- Development Guides -->
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Development Guides</div>
                    <ul>
                        <li><a href="../guides/api-development.html" class="sidebar-nav-link">API Development</a></li>
                        <li><a href="../guides/script-development.html" class="sidebar-nav-link">Script Development</a></li>
                        <li><a href="../guides/configuration.html" class="sidebar-nav-link">Configuration</a></li>
                        <li><a href="../guides/deployment.html" class="sidebar-nav-link">Deployment</a></li>
                    </ul>
                </div>

                <!-- GCP Integration -->
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">GCP Integration</div>
                    <ul>
                        <li><a href="../guides/gcp-integration.html" class="sidebar-nav-link">GCP Overview</a></li>
                        <li><a href="../guides/security.html" class="sidebar-nav-link">Security</a></li>
                        <li><a href="../guides/testing.html" class="sidebar-nav-link">Testing</a></li>
                    </ul>
                </div>

                <!-- Core Classes -->
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Core Classes</div>
                    <ul>
                        <li><a href="Core7.html" class="sidebar-nav-link">Core7</a></li>
                        <li><a href="RESTful.html" class="sidebar-nav-link">RESTful</a></li>
                        <li><a href="Scripts2020.html" class="sidebar-nav-link">Scripts2020</a></li>
                    </ul>
                </div>

                <!-- Configuration Classes -->
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Configuration</div>
                    <ul>
                        <li><a href="CoreConfig.html" class="sidebar-nav-link">CoreConfig</a></li>
                        <li><a href="CoreCache.html" class="sidebar-nav-link">CoreCache</a></li>
                        <li><a href="CoreSession.html" class="sidebar-nav-link">CoreSession</a></li>
                        <li><a href="CoreSecurity.html" class="sidebar-nav-link">CoreSecurity</a></li>
                    </ul>
                </div>

                <!-- Data Access Classes -->
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Data Access</div>
                    <ul>
                        <li><a href="DataStore.html" class="sidebar-nav-link">DataStore</a></li>
                        <li><a href="Buckets.html" class="sidebar-nav-link active">Buckets</a></li>
                        <li><a href="DataBQ.html" class="sidebar-nav-link">DataBQ</a></li>
                        <li><a href="CloudSQL.html" class="sidebar-nav-link">CloudSQL</a></li>
                        <li><a href="DataSQL.html" class="sidebar-nav-link">DataSQL</a></li>
                        <li><a href="DataMongoDB.html" class="sidebar-nav-link">DataMongoDB</a></li>
                    </ul>
                </div>

                <!-- Utilities -->
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Utilities</div>
                    <ul>
                        <li><a href="Email.html" class="sidebar-nav-link">Email</a></li>
                        <li><a href="DataValidation.html" class="sidebar-nav-link">DataValidation</a></li>
                        <li><a href="WorkFlows.html" class="sidebar-nav-link">WorkFlows</a></li>
                        <li><a href="GoogleSecrets.html" class="sidebar-nav-link">GoogleSecrets</a></li>
                        <li><a href="PubSub.html" class="sidebar-nav-link">PubSub</a></li>
                    </ul>
                </div>

                <!-- Examples -->
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Examples</div>
                    <ul>
                        <li><a href="../examples/api-examples.html" class="sidebar-nav-link">API Examples</a></li>
                        <li><a href="../examples/script-examples.html" class="sidebar-nav-link">Script Examples</a></li>
                    </ul>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
<h1>Buckets Class</h1>

<h2>Overview</h2>

The <code>Buckets</code> class provides a comprehensive interface to Google Cloud Storage (GCS), allowing you to manage files, directories, and objects in GCS buckets. It handles uploads, downloads, permissions, signed URLs, and more.

<h2>Requirements</h2>

<ul>
<li>Google Cloud Storage API enabled</li>
<li>Service account with Storage Object Admin role</li>
<li>Configuration in <code>config.json</code>:</li>
</ul>
  <pre><code class="language-json">  {
    "core.datastorage.on": true,
    "core.gcp.datastorage.project_id": "your-project-id"
  }
  </code></pre>

<h2>Basic Usage</h2>

<pre><code class="language-php">// Load Buckets class
$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

// Check for errors
if($buckets->error) {
    echo "Error: " . implode(', ', $buckets->errorMsg);
    return;
}

// Upload file
$buckets->uploadFile('/path/in/bucket/file.pdf', '/local/path/file.pdf');

// Download file
$buckets->download('gs://my-bucket/file.pdf', '/local/destination.pdf');

// List files
$files = $buckets->scan('/documents/');

// Delete file
$buckets->deleteFile('/path/in/bucket/file.pdf');
</code></pre>

<h2>Constructor</h2>

<pre><code class="language-php">function __construct(Core7 &$core, $bucket = null, $options = [])
</code></pre>

<strong>Parameters:</strong>
<ul>
<li><code>$bucket</code> (string): Bucket name in format <code>gs://bucket-name</code> or just <code>bucket-name</code></li>
<li><code>$options</code> (array, optional): Additional options</li>
</ul>
<p>- <code>project_id</code> (string): GCP project ID - <code>keyFile</code> (array): Service account credentials</p>

<strong>Example:</strong>
<pre><code class="language-php">// Simple initialization
$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

// With project ID
$buckets = $this->core->loadClass('Buckets', [
    'gs://my-bucket',
    ['project_id' => 'my-project']
]);

// With service account
$buckets = $this->core->loadClass('Buckets', [
    'gs://my-bucket',
    ['keyFile' => $serviceAccountArray]
]);
</code></pre>

<p>---</p>

<h2>File Upload Methods</h2>

<h3>manageUploadFiles()</h3>

<pre><code class="language-php">function manageUploadFiles($path = '', $options = []): array|false
</code></pre>

<p>Manages files uploaded via <code>$_FILES</code> and moves them to Cloud Storage.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$path</code> (string): Destination path in bucket (must start with <code>/</code>)</li>
<li><code>$options</code> (array): Upload options</li>
</ul>
<p>- <code>public</code> (bool): Make files publicly accessible - <code>field_name</code> (string): Process only specific field name - <code>apply_hash_to_filenames</code> (bool): Rename files with hash to avoid duplicates - <code>allowed_extensions</code> (string): Comma-separated allowed extensions (e.g., 'jpg,pdf,png') - <code>allowed_content_types</code> (string): Comma-separated allowed content types (e.g., 'image,application/pdf')</p>

<strong>Returns:</strong> Array of uploaded files with details, or <code>false</code> on error

<strong>Example:</strong>
<pre><code class="language-php">// In your API endpoint
public function ENDPOINT_upload()
{
    if(!isset($_FILES['documents'])) {
        return $this->setError('No files uploaded', 400);
    }

    $buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

    // Configure upload options
    $options = [
        'public' => true,
        'apply_hash_to_filenames' => true,
        'allowed_extensions' => 'jpg,png,pdf',
        'allowed_content_types' => 'image,application/pdf'
    ];

    // Upload files
    $uploaded = $buckets->manageUploadFiles('/uploads', $options);

    if($buckets->error) {
        return $this->setError(implode(', ', $buckets->errorMsg), 400);
    }

    $this->addReturnData($uploaded);
}
</code></pre>

<strong>Response Structure:</strong>
<pre><code class="language-json">{
  "field_name": [
    {
      "name": "20221221042421_upload63a9cab5988ac.jpg",
      "type": "image/jpeg",
      "tmp_name": "/tmp/phpG9pBMz",
      "error": 0,
      "size": 1412041,
      "hash_from_name": "original-filename.jpg",
      "movedTo": "gs://my-bucket/uploads/20221221042421_upload63a9cab5988ac.jpg",
      "publicUrl": "https://storage.googleapis.com/my-bucket/uploads/file.jpg",
      "mediaLink": "https://storage.googleapis.com/download/storage/v1/b/..."
    }
  ]
}
</code></pre>

<p>---</p>

<h3>uploadFile()</h3>

<pre><code class="language-php">function uploadFile(string $filename_path, string $source_file_path, array $options = []): bool
</code></pre>

<p>Uploads a file from local filesystem to Cloud Storage.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$filename_path</code> (string): Destination path in bucket (with or without <code>gs://</code>)</li>
<li><code>$source_file_path</code> (string): Source file path on local filesystem</li>
<li><code>$options</code> (array): Upload options</li>
</ul>
<p>- <code>public</code> (bool): Make file publicly accessible - <code>metadata</code> (array): Custom metadata - <code>contentType</code> (string): Content-Type header - <code>cacheControl</code> (string): Cache-Control header</p>

<strong>Returns:</strong> <code>true</code> on success, <code>false</code> on error

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

// Simple upload
$buckets->uploadFile('/documents/report.pdf', '/local/path/report.pdf');

// Upload with options
$buckets->uploadFile(
    '/images/photo.jpg',
    '/tmp/photo.jpg',
    [
        'public' => true,
        'metadata' => ['user_id' => '123', 'uploaded_at' => date('Y-m-d H:i:s')],
        'contentType' => 'image/jpeg',
        'cacheControl' => 'public, max-age=3600'
    ]
);

if($buckets->error) {
    echo "Upload failed: " . implode(', ', $buckets->errorMsg);
}
</code></pre>

<p>---</p>

<h3>uploadContents()</h3>

<pre><code class="language-php">function uploadContents(string $filename_path, string $contents, array $options = []): bool
</code></pre>

<p>Uploads content directly to Cloud Storage without using a local file.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$filename_path</code> (string): Destination path in bucket</li>
<li><code>$contents</code> (string): File contents</li>
<li><code>$options</code> (array): Upload options (same as <code>uploadFile</code>)</li>
</ul>

<strong>Returns:</strong> <code>true</code> on success, <code>false</code> on error

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

// Upload text content
$buckets->uploadContents(
    '/data/config.json',
    json_encode(['key' => 'value']),
    ['contentType' => 'application/json']
);

// Upload generated CSV
$csv = "Name,Email\nJohn,john@example.com\nJane,jane@example.com";
$buckets->uploadContents('/exports/users.csv', $csv);

// Upload image from memory
$imageData = file_get_contents('php://input');
$buckets->uploadContents('/uploads/image.jpg', $imageData, ['public' => true]);
</code></pre>

<p>---</p>

<h3>putContents()</h3>

<pre><code class="language-php">function putContents(string $filename, $data, string $path = '', array $options = []): bool
</code></pre>

<p>Alternative method to upload contents to a file.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$filename</code> (string): File name</li>
<li><code>$data</code> (string): File contents</li>
<li><code>$path</code> (string): Directory path in bucket</li>
<li><code>$options</code> (array): Upload options</li>
</ul>

<strong>Returns:</strong> <code>true</code> on success, <code>false</code> on error

<strong>Example:</strong>
<pre><code class="language-php">$buckets->putContents('data.json', json_encode($data), '/exports/');
</code></pre>

<p>---</p>

<h2>File Download Methods</h2>

<h3>getContents()</h3>

<pre><code class="language-php">function getContents($file, $path = ''): string|false
</code></pre>

<p>Downloads and returns file contents as a string.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$file</code> (string): File name or full path</li>
<li><code>$path</code> (string): Directory path (if $file is just filename)</li>
</ul>

<strong>Returns:</strong> File contents as string, or <code>false</code> on error

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

// Get file contents
$contents = $buckets->getContents('/data/config.json');

if($contents) {
    $config = json_decode($contents, true);
}

// Alternative syntax
$contents = $buckets->getContents('config.json', '/data/');

// Download image
$imageData = $buckets->getContents('/images/photo.jpg');
if($imageData) {
    header('Content-Type: image/jpeg');
    echo $imageData;
}
</code></pre>

<p>---</p>

<h3>download()</h3>

<pre><code class="language-php">function download(string $source, string $destination): bool
</code></pre>

<p>Downloads a file from Cloud Storage to local filesystem.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$source</code> (string): Source file path in bucket (with or without <code>gs://</code>)</li>
<li><code>$destination</code> (string): Local destination path</li>
</ul>

<strong>Returns:</strong> <code>true</code> on success, <code>false</code> on error

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

// Download file
$buckets->download(
    'gs://my-bucket/documents/report.pdf',
    '/tmp/report.pdf'
);

// Download without gs:// prefix
$buckets->download(
    '/exports/data.csv',
    '/local/path/data.csv'
);

if($buckets->error) {
    echo "Download failed: " . implode(', ', $buckets->errorMsg);
}
</code></pre>

<p>---</p>

<h2>Directory Methods</h2>

<h3>mkdir()</h3>

<pre><code class="language-php">public function mkdir(string $path): bool
</code></pre>

<p>Creates a directory in the bucket.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$path</code> (string): Directory path (must start with <code>/</code>)</li>
</ul>

<strong>Returns:</strong> <code>true</code> on success or if already exists, <code>false</code> on error

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

// Create directory
$buckets->mkdir('/uploads/2024/');
$buckets->mkdir('/documents/invoices/');

// Nested directories
$buckets->mkdir('/data/exports/monthly/2024/');
</code></pre>

<p>---</p>

<h3>rmdir()</h3>

<pre><code class="language-php">public function rmdir(string $path): bool
</code></pre>

<p>Removes a directory and all its contents.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$path</code> (string): Directory path</li>
</ul>

<strong>Returns:</strong> <code>true</code> on success, <code>false</code> on error

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

// Remove directory and all files in it
$buckets->rmdir('/temp/');
$buckets->rmdir('gs://my-bucket/old-data/');

if($buckets->error) {
    echo "Failed to remove directory";
}
</code></pre>

<p>---</p>

<h3>isDir()</h3>

<pre><code class="language-php">public function isDir($path = ''): bool
</code></pre>

<p>Checks if a path is a directory.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$path</code> (string): Directory path</li>
</ul>

<strong>Returns:</strong> <code>true</code> if directory exists, <code>false</code> otherwise

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

if($buckets->isDir('/uploads/')) {
    echo "Directory exists";
} else {
    $buckets->mkdir('/uploads/');
}
</code></pre>

<p>---</p>

<h3>scan()</h3>

<pre><code class="language-php">function scan(string $path = ''): array|false
</code></pre>

<p>Scans a directory and returns detailed file information.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$path</code> (string): Directory path to scan</li>
</ul>

<strong>Returns:</strong> Array of file objects with details, or <code>false</code> on error

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

// Scan directory
$files = $buckets->scan('/documents/');

foreach($files as $file) {
    echo $file['name'];           // File name
    echo $file['size'];           // File size in bytes
    echo $file['timeCreated'];    // Creation timestamp
    echo $file['updated'];        // Last update timestamp
    echo $file['contentType'];    // MIME type
    echo $file['mediaLink'];      // Download URL
}

// Scan subdirectory
$images = $buckets->scan('/uploads/images/');
</code></pre>

<p>---</p>

<h3>fastScan()</h3>

<pre><code class="language-php">function fastScan(string $path = ''): array|false
</code></pre>

<p>Quickly scans a directory and returns just file names (faster than <code>scan()</code>).</p>

<strong>Parameters:</strong>
<ul>
<li><code>$path</code> (string): Directory path to scan</li>
</ul>

<strong>Returns:</strong> Array of file names, or <code>false</code> on error

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

// Quick scan for file names only
$fileNames = $buckets->fastScan('/documents/');

// Result: ['file1.pdf', 'file2.docx', 'file3.txt']

foreach($fileNames as $fileName) {
    echo $fileName . "\n";
}
</code></pre>

<p>---</p>

<h2>File Operations</h2>

<h3>deleteFile()</h3>

<pre><code class="language-php">function deleteFile(string $filename_path): bool
</code></pre>

<p>Deletes a file from Cloud Storage.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$filename_path</code> (string): File path to delete</li>
</ul>

<strong>Returns:</strong> <code>true</code> on success, <code>false</code> on error

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

// Delete file
$buckets->deleteFile('/uploads/old-file.pdf');
$buckets->deleteFile('gs://my-bucket/temp/data.csv');

if($buckets->error) {
    echo "Delete failed";
}
</code></pre>

<p>---</p>

<h3>copyFile()</h3>

<pre><code class="language-php">function copyFile(string $filename_path_source, string $filename_path_target): bool
</code></pre>

<p>Copies a file to a new location.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$filename_path_source</code> (string): Source file path</li>
<li><code>$filename_path_target</code> (string): Destination file path</li>
</ul>

<strong>Returns:</strong> <code>true</code> on success, <code>false</code> on error

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

// Copy file
$buckets->copyFile(
    '/documents/report.pdf',
    '/backups/report-backup.pdf'
);

// Copy between directories
$buckets->copyFile(
    '/uploads/photo.jpg',
    '/archive/2024/photo.jpg'
);
</code></pre>

<p>---</p>

<h3>moveFile()</h3>

<pre><code class="language-php">function moveFile(string $filename_path_source, string $filename_path_target): bool
</code></pre>

<p>Moves a file to a new location (copy + delete).</p>

<strong>Parameters:</strong>
<ul>
<li><code>$filename_path_source</code> (string): Source file path</li>
<li><code>$filename_path_target</code> (string): Destination file path</li>
</ul>

<strong>Returns:</strong> <code>true</code> on success, <code>false</code> on error

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

// Move file
$buckets->moveFile(
    '/temp/upload.pdf',
    '/documents/final.pdf'
);

// Rename file
$buckets->moveFile(
    '/uploads/IMG_001.jpg',
    '/uploads/profile-photo.jpg'
);
</code></pre>

<p>---</p>

<h3>isFile()</h3>

<pre><code class="language-php">function isFile(string $path): bool
</code></pre>

<p>Checks if a file exists.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$path</code> (string): File path</li>
</ul>

<strong>Returns:</strong> <code>true</code> if file exists, <code>false</code> otherwise

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

if($buckets->isFile('/documents/report.pdf')) {
    echo "File exists";
} else {
    echo "File not found";
}
</code></pre>

<p>---</p>

<h2>Permission Methods</h2>

<h3>setFilePublic()</h3>

<pre><code class="language-php">function setFilePublic(string $file_path): bool
</code></pre>

<p>Makes a file publicly accessible.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$file_path</code> (string): File path</li>
</ul>

<strong>Returns:</strong> <code>true</code> on success, <code>false</code> on error

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

// Make file public
$buckets->setFilePublic('/documents/public-report.pdf');

// Get public URL
$publicUrl = $buckets->getPublicUrl('/documents/public-report.pdf');
</code></pre>

<p>---</p>

<h3>setFilePrivate()</h3>

<pre><code class="language-php">function setFilePrivate(string $file_path): bool
</code></pre>

<p>Makes a file private (removes public access).</p>

<strong>Parameters:</strong>
<ul>
<li><code>$file_path</code> (string): File path</li>
</ul>

<strong>Returns:</strong> <code>true</code> on success, <code>false</code> on error

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

// Make file private
$buckets->setFilePrivate('/documents/confidential.pdf');
</code></pre>

<p>---</p>

<h2>Signed URL Methods</h2>

<h3>getSignedUploadUrl()</h3>

<pre><code class="language-php">function getSignedUploadUrl($upload_file_path, int $expiration_in_minutes = 15): string|false
</code></pre>

<p>Generates a signed URL for uploading files directly to Cloud Storage.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$upload_file_path</code> (string): Destination file path</li>
<li><code>$expiration_in_minutes</code> (int): URL expiration time (default: 15 minutes)</li>
</ul>

<strong>Returns:</strong> Signed URL string, or <code>false</code> on error

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

// Generate upload URL
$uploadUrl = $buckets->getSignedUploadUrl('/uploads/user-file.pdf', 30);

// Return to client for direct upload
$this->addReturnData([
    'upload_url' => $uploadUrl,
    'expires_in' => 30 * 60 // seconds
]);

// Client-side (JavaScript)
// fetch(uploadUrl, {
//   method: 'PUT',
//   body: file,
//   headers: {'Content-Type': 'application/pdf'}
// });
</code></pre>

<p>---</p>

<h3>getSignedDownloadUrl()</h3>

<pre><code class="language-php">function getSignedDownloadUrl($filename_path, int $expiration_in_minutes = 1, $download_options = []): string|false
</code></pre>

<p>Generates a signed URL for downloading private files.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$filename_path</code> (string): File path</li>
<li><code>$expiration_in_minutes</code> (int): URL expiration time (default: 1 minute)</li>
<li><code>$download_options</code> (array): Additional options</li>
</ul>
<p>- <code>responseDisposition</code> (string): Content-Disposition header - <code>responseType</code> (string): Content-Type override</p>

<strong>Returns:</strong> Signed URL string, or <code>false</code> on error

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

// Simple signed URL
$downloadUrl = $buckets->getSignedDownloadUrl('/documents/report.pdf', 5);

// Force download with custom filename
$downloadUrl = $buckets->getSignedDownloadUrl(
    '/documents/report.pdf',
    10,
    ['responseDisposition' => 'attachment; filename="My-Report.pdf"']
);

// Return to client
$this->addReturnData([
    'download_url' => $downloadUrl,
    'expires_in' => 600 // seconds
]);
</code></pre>

<p>---</p>

<h2>Information Methods</h2>

<h3>getPublicUrl()</h3>

<pre><code class="language-php">function getPublicUrl(string $file_path, string $content_type = ''): string|false
</code></pre>

<p>Gets the public URL for a file.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$file_path</code> (string): File path</li>
<li><code>$content_type</code> (string): Content-Type (optional)</li>
</ul>

<strong>Returns:</strong> Public URL string, or <code>false</code> if not public

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

// Get public URL
$url = $buckets->getPublicUrl('/images/photo.jpg');
// Returns: https://storage.googleapis.com/my-bucket/images/photo.jpg

// Use in response
$this->addReturnData([
    'image_url' => $url
]);
</code></pre>

<p>---</p>

<h3>getFileInfo()</h3>

<pre><code class="language-php">function getFileInfo(string $file_path): array|false
</code></pre>

<p>Gets detailed information about a file.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$file_path</code> (string): File path</li>
</ul>

<strong>Returns:</strong> File information array, or <code>false</code> on error

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

$info = $buckets->getFileInfo('/documents/report.pdf');

if($info) {
    echo $info['name'];           // File name
    echo $info['size'];           // Size in bytes
    echo $info['contentType'];    // MIME type
    echo $info['timeCreated'];    // Creation time
    echo $info['updated'];        // Last update time
    echo $info['md5Hash'];        // MD5 hash
    echo $info['crc32c'];         // CRC32C checksum
    echo $info['mediaLink'];      // Download link
    echo $info['metadata'];       // Custom metadata
}
</code></pre>

<p>---</p>

<h3>getInfo()</h3>

<pre><code class="language-php">function getInfo(): array
</code></pre>

<p>Gets information about the bucket.</p>

<strong>Returns:</strong> Bucket information array

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

$info = $buckets->getInfo();

echo $info['name'];              // Bucket name
echo $info['location'];          // Bucket location
echo $info['storageClass'];      // Storage class
echo $info['timeCreated'];       // Creation time
</code></pre>

<p>---</p>

<h3>getBucketPath()</h3>

<pre><code class="language-php">public function getBucketPath(string $path): string
</code></pre>

<p>Converts a path to full bucket path format.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$path</code> (string): Relative or absolute path</li>
</ul>

<strong>Returns:</strong> Full bucket path (gs://bucket-name/path)

<strong>Example:</strong>
<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

$fullPath = $buckets->getBucketPath('/documents/file.pdf');
// Returns: gs://my-bucket/documents/file.pdf

$fullPath = $buckets->getBucketPath('gs://my-bucket/file.pdf');
// Returns: gs://my-bucket/file.pdf
</code></pre>

<p>---</p>

<h3>getMimeTypeFromExtension()</h3>

<pre><code class="language-php">public function getMimeTypeFromExtension(string $extension): string
</code></pre>

<p>Gets MIME type from file extension.</p>

<strong>Parameters:</strong>
<ul>
<li><code>$extension</code> (string): File extension (with or without dot)</li>
</ul>

<strong>Returns:</strong> MIME type string

<strong>Example:</strong>
<pre><code class="language-php">$mime = $buckets->getMimeTypeFromExtension('pdf');
// Returns: application/pdf

$mime = $buckets->getMimeTypeFromExtension('.jpg');
// Returns: image/jpeg

$mime = $buckets->getMimeTypeFromExtension('json');
// Returns: application/json
</code></pre>

<p>---</p>

<h2>Error Handling</h2>

The Buckets class provides error information through properties:

<pre><code class="language-php">$buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

// Check for errors
if($buckets->error) {
    echo "Error Code: " . $buckets->errorCode . "\n";
    echo "Error Messages: " . implode(', ', $buckets->errorMsg) . "\n";
}

// Example with error handling
$result = $buckets->uploadFile('/path/file.pdf', '/local/file.pdf');

if($buckets->error) {
    $this->core->logs->add($buckets->errorMsg, 'buckets', 'error');
    return $this->setError('Upload failed', 500);
}
</code></pre>

<p>---</p>

<h2>Complete Examples</h2>

<h3>File Upload API</h3>

<pre><code class="language-php"><?php
class API extends RESTful
{
    // POST /storage/upload
    public function ENDPOINT_upload()
    {
        if(!$this->checkMethod('POST')) return;

        // Check uploaded files
        if(!isset($_FILES['file'])) {
            return $this->setError('No file uploaded', 400);
        }

        // Load Buckets
        $buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);
        if($buckets->error) {
            return $this->setError('Storage initialization failed', 500);
        }

        // Configure upload
        $options = [
            'public' => true,
            'apply_hash_to_filenames' => true,
            'allowed_extensions' => 'jpg,png,pdf,docx',
            'allowed_content_types' => 'image,application/pdf,application/vnd.openxmlformats'
        ];

        // Upload files
        $uploaded = $buckets->manageUploadFiles('/uploads/' . date('Y/m/'), $options);

        if($buckets->error) {
            return $this->setError(implode(', ', $buckets->errorMsg), 400);
        }

        $this->setReturnStatus(201);
        $this->addReturnData($uploaded);
    }
}
</code></pre>

<h3>File Download API</h3>

<pre><code class="language-php">// GET /storage/download/{filename}
public function ENDPOINT_download()
{
    if(!$this->checkMethod('GET')) return;

    $filename = $this->checkMandatoryParam(1, 'Filename required');
    if(!$filename) return;

    $buckets = $this->core->loadClass('Buckets', ['gs://my-bucket']);

    // Check if file exists
    $filePath = '/documents/' . $filename;
    if(!$buckets->isFile($filePath)) {
        return $this->setError('File not found', 404);
    }

    // Generate signed download URL
    $downloadUrl = $buckets->getSignedDownloadUrl($filePath, 5, [
        'responseDisposition' => 'attachment; filename="' . $filename . '"'
    ]);

    if($buckets->error) {
        return $this->setError('Failed to generate download URL', 500);
    }

    // Redirect to signed URL
    header('Location: ' . $downloadUrl);
    exit;
}
</code></pre>

<h3>Image Gallery</h3>

<pre><code class="language-php">// GET /gallery/list
public function ENDPOINT_list()
{
    $buckets = $this->core->loadClass('Buckets', ['gs://my-images']);

    // Scan images directory
    $files = $buckets->scan('/gallery/');

    if($buckets->error) {
        return $this->setError('Failed to list files', 500);
    }

    // Filter images and add public URLs
    $images = [];
    foreach($files as $file) {
        if(strpos($file['contentType'], 'image/') === 0) {
            $images[] = [
                'name' => $file['name'],
                'size' => $file['size'],
                'url' => $buckets->getPublicUrl('/gallery/' . $file['name']),
                'created' => $file['timeCreated']
            ];
        }
    }

    $this->addReturnData(['images' => $images, 'total' => count($images)]);
}
</code></pre>

<p>---</p>

<h2>See Also</h2>

<ul>
<li><a href="../guides/getting-started.html">Getting Started Guide</a></li>
<li><a href="../guides/gcp-integration.html">GCP Integration Guide</a></li>
<li><a href="DataStore.html">DataStore Class</a></li>
<li><a href="../guides/api-development.html">API Development Guide</a></li>
</ul>

        </main>
    </div>

    <script src="../js/main.js"></script>
</body>
</html>